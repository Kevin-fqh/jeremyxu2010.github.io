<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>研究调用链跟踪技术之jaeger - jeremy的技术点滴</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Jeremy Xu" />
  <meta name="description" content="最近在做微服务构架里有关调用链跟踪（也有叫分布式追踪）的部分，有一些心得，这里总结一些。 为什么有必要跟踪调用链 当我们进行微服务架构开发时，通" />




<meta name="google-site-verification" content="Ol4gI1XKZ2qsa-efwwJvaGeDyXb91RL-pZBv-3uyY-A" />


<meta name="generator" content="Hugo " />


<link rel="canonical" href="https://jeremyxu2010.github.io/2018/07/%E7%A0%94%E7%A9%B6%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%9F%E8%B8%AA%E6%8A%80%E6%9C%AF%E4%B9%8Bjaeger/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.1.1" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">



<link rel="stylesheet" href="/css/mathjax.css">


<meta property="og:title" content="研究调用链跟踪技术之jaeger" />
<meta property="og:description" content="最近在做微服务构架里有关调用链跟踪（也有叫分布式追踪）的部分，有一些心得，这里总结一些。 为什么有必要跟踪调用链 当我们进行微服务架构开发时，通" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jeremyxu2010.github.io/2018/07/%E7%A0%94%E7%A9%B6%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%9F%E8%B8%AA%E6%8A%80%E6%9C%AF%E4%B9%8Bjaeger/" />
<meta property="article:published_time" content="2018-07-22T12:30:00+08:00" />
<meta property="article:modified_time" content="2018-07-22T12:30:00+08:00" />
<meta itemprop="name" content="研究调用链跟踪技术之jaeger">
<meta itemprop="description" content="最近在做微服务构架里有关调用链跟踪（也有叫分布式追踪）的部分，有一些心得，这里总结一些。 为什么有必要跟踪调用链 当我们进行微服务架构开发时，通">
<meta itemprop="datePublished" content="2018-07-22T12:30:00&#43;08:00" />
<meta itemprop="dateModified" content="2018-07-22T12:30:00&#43;08:00" />
<meta itemprop="wordCount" content="3577">



<meta itemprop="keywords" content="golang,jaeger," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="研究调用链跟踪技术之jaeger"/>
<meta name="twitter:description" content="最近在做微服务构架里有关调用链跟踪（也有叫分布式追踪）的部分，有一些心得，这里总结一些。 为什么有必要跟踪调用链 当我们进行微服务架构开发时，通"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">jeremy的技术点滴</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/search/">
        <li class="mobile-menu-item">Search</li>
      </a>
  </ul>
</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">jeremy的技术点滴</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/search/">Search</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">研究调用链跟踪技术之jaeger</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-07-22 </span>
        <div class="post-category">
            
              <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"> 微服务 </a>
            
          </div>
        <span class="more-meta"> 约 3577 字 </span>
        <span class="more-meta"> 预计阅读 8 分钟 </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#heading">为什么有必要跟踪调用链</a></li>
    <li><a href="#heading-1">调用链跟踪系统选型</a>
      <ul>
        <li><a href="#heading-2">特性对比</a></li>
        <li><a href="#heading-3">架构对比</a></li>
        <li><a href="#heading-4">社区活跃性对比</a></li>
        <li><a href="#heading-5">结论</a></li>
      </ul>
    </li>
    <li><a href="#getting-started">Getting Started</a></li>
    <li><a href="#trace-instrumentation">Trace Instrumentation写法</a>
      <ul>
        <li><a href="#tracer">初始化Tracer</a></li>
        <li><a href="#httphandler">嵌入代码至http.Handler</a></li>
        <li><a href="#httpclient">嵌入代码至http.Client</a></li>
        <li><a href="#spantag">给Span添加自定义tag</a></li>
        <li><a href="#spanlog">给Span添加相关的log</a></li>
        <li><a href="#trace-instrumentation-1">其它接口调用的Trace Instrumentation</a></li>
      </ul>
    </li>
    <li><a href="#jaeger">jaeger的源码解析</a></li>
    <li><a href="#heading-6">参考</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>最近在做微服务构架里有关调用链跟踪（也有叫分布式追踪）的部分，有一些心得，这里总结一些。</p>
<h2 id="heading">为什么有必要跟踪调用链</h2>
<p>当我们进行微服务架构开发时，通常会根据业务来划分微服务，各业务之间通过REST进行调用。一个用户操作，可能需要很多微服务的协同才能完成，如果在业务调用链路上任何一个微服务出现问题或者网络超时，都会导致功能失败。随着业务越来越多，对于微服务之间的调用链的分析会越来越复杂。通过追踪调用链，我们可以很方便的理清各微服务间的调用关系，同时调用链还可以帮助我们：</p>
<ul>
<li><strong>耗时分析:</strong> 通过Sleuth可以很方便的了解到每个采样请求的耗时，从而分析出哪些服务调用比较耗时;</li>
<li><strong>可视化错误:</strong> 对于程序未捕捉的异常，可以通过集成的界面上看到;</li>
<li><strong>链路优化:</strong> 对于调用比较频繁的服务，可以针对这些服务实施一些优化措施。</li>
</ul>
<h2 id="heading-1">调用链跟踪系统选型</h2>
<p>拿<code>Distributed Tracing</code>这个关键词在google里搜索，基本第一页就列出了最流行的分布式追踪系统：<a href="https://zipkin.io/">OpenZipkin</a>、<a href="https://www.jaegertracing.io/">Jaeger</a>。那就直接在这两个里选型好了。</p>
<h3 id="heading-2">特性对比</h3>
<p>两者的特性对比矩阵（摘自<a href="https://sematext.com/blog/jaeger-vs-zipkin-opentracing-distributed-tracers/">https://sematext.com/blog/jaeger-vs-zipkin-opentracing-distributed-tracers/</a>，截至May 23, 2018)：</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>JAEGER</strong></th>
<th><strong>ZIPKIN</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>OpenTracing compatibility</strong></td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><strong>OpenTracing-compatible clients</strong></td>
<td><a href="https://github.com/uber/jaeger-client-python">Python</a><!-- raw HTML omitted --><a href="https://github.com/uber/jaeger-client-go">Go</a><!-- raw HTML omitted --><a href="https://github.com/uber/jaeger-client-node">Node</a><!-- raw HTML omitted --><a href="https://github.com/uber/jaeger-client-java">Java</a><!-- raw HTML omitted --><a href="https://github.com/jaegertracing/jaeger-client-cpp">C++</a><!-- raw HTML omitted --><a href="https://github.com/jaegertracing/jaeger-client-csharp">C#</a><!-- raw HTML omitted --><a href="https://github.com/salemove/jaeger-client-ruby">Ruby</a> <!-- raw HTML omitted --><code>*</code><a href="https://github.com/jukylin/jaeger-php">PHP</a><!-- raw HTML omitted --><code>*</code><a href="https://github.com/sile/rustracing_jaeger">Rust</a></td>
<td><a href="https://github.com/openzipkin/zipkin-go-opentracing">Go</a><!-- raw HTML omitted --><a href="https://github.com/openzipkin-contrib/brave-opentracing">Java</a><!-- raw HTML omitted --><a href="https://github.com/salemove/zipkin-ruby-opentracing">Ruby</a><!-- raw HTML omitted --><code>*</code><a href="https://github.com/rnburn/zipkin-cpp-opentracing">C++</a><!-- raw HTML omitted -->Python (work in <a href="https://github.com/openzipkin-attic/zipkin-python-opentracing/pull/1">progress</a>)</td>
</tr>
<tr>
<td><strong>Storage support</strong></td>
<td>In-memory<!-- raw HTML omitted -->CassandraElasticsearch<!-- raw HTML omitted -->ScyllaDB (work in <a href="https://github.com/uber/jaeger/pull/201">progress</a>)</td>
<td>In-memory<!-- raw HTML omitted -->MySQL<!-- raw HTML omitted -->CassandraElasticsearch</td>
</tr>
<tr>
<td><strong>Sampling</strong></td>
<td>Dynamic sampling rate   (supports rate limiting and  probabilistic sampling strategies)</td>
<td>Fixed sampling rate (supports probabilistic sampling strategy)</td>
</tr>
<tr>
<td><strong>Span transport</strong></td>
<td>UDP<!-- raw HTML omitted -->HTTP</td>
<td>HTTP<!-- raw HTML omitted -->Kafka<!-- raw HTML omitted -->Scribe<!-- raw HTML omitted -->AMQP</td>
</tr>
<tr>
<td><strong>Docker ready</strong></td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p><code>*</code> non-official OpenTracing clients</p>
<p>从上面的特性矩阵来年，在兼容的客户端语言和采样策略上jaeger胜出，在支持的传输层技术上zipkin胜出，其它都是差不多的水平。</p>
<h3 id="heading-3">架构对比</h3>
<p>两者都是 <a href="http://research.google.com/pubs/pub36356.html">Google Dapper</a> 这篇pager的实现，因此原理及架构是差不多了，但两者的架构有一点点小差异。</p>
<p><strong>openzipkin的架构图</strong></p>
<p><img src="/images/20180722/architecture-1.png" alt="openzipkin的架构图"></p>
<p><strong>jaeger架构图</strong></p>
<p><img src="/images/20180722/architecture.png" alt="jaeger架构图"></p>
<p>从以上架构图可以看出，jaeger将jaeger-agent从业务应用中抽出，部署在宿主机或容器中，专门负责向collector异步上报调用链跟踪数据，这样做将业务应用与collector解耦了，同时也减少了业务应用的第三方依赖。因此从架构上来看，明显jaeger胜出了。</p>
<p>另外jaeger整体是用go语言编写的，在并发性能、对系统资源的消耗上也对基于java的openzipkin好不少。</p>
<h3 id="heading-4">社区活跃性对比</h3>
<p>github上项目的关键指标如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl <span style="color:#e6db74">&#39;https://api.github.com/repos/openzipkin/zipkin&#39;</span> 2&gt;/dev/null | grep -E <span style="color:#e6db74">&#39;created_at|updated_at|stargazers_count|watchers_count|forks_count&#39;</span>
  <span style="color:#e6db74">&#34;created_at&#34;</span>: <span style="color:#e6db74">&#34;2012-06-06T18:26:16Z&#34;</span>,
  <span style="color:#e6db74">&#34;updated_at&#34;</span>: <span style="color:#e6db74">&#34;2018-07-22T13:36:01Z&#34;</span>,
  <span style="color:#e6db74">&#34;stargazers_count&#34;</span>: 9039,
  <span style="color:#e6db74">&#34;watchers_count&#34;</span>: 9039,
  <span style="color:#e6db74">&#34;forks_count&#34;</span>: 1500,

$ curl <span style="color:#e6db74">&#39;https://api.github.com/repos/jaegertracing/jaeger&#39;</span> 2&gt;/dev/null | grep -E <span style="color:#e6db74">&#39;created_at|updated_at|stargazers_count|watchers_count|forks_count&#39;</span>
  <span style="color:#e6db74">&#34;created_at&#34;</span>: <span style="color:#e6db74">&#34;2016-04-15T18:49:02Z&#34;</span>,
  <span style="color:#e6db74">&#34;updated_at&#34;</span>: <span style="color:#e6db74">&#34;2018-07-22T10:46:39Z&#34;</span>,
  <span style="color:#e6db74">&#34;stargazers_count&#34;</span>: 5184,
  <span style="color:#e6db74">&#34;watchers_count&#34;</span>: 5184,
  <span style="color:#e6db74">&#34;forks_count&#34;</span>: 414,
</code></pre></div><p>两者最近都属于活跃开发中，值得注意的是jaeger比openzipkin晚诞生4年，但start及watch的数量已有后者的一半了，可谓发展迅猛。另外还有一点值得注意的是jaeger是<a href="https://www.cncf.io/">Cloud Native Computing Foundation</a>的项目，因此云原生的项目都会支持它。</p>
<h3 id="heading-5">结论</h3>
<p>综上所述，这里就愉快地选择jaeger了。</p>
<h2 id="getting-started">Getting Started</h2>
<p>为了便于研究，先把官方的<a href="https://jaegertracing.io/docs/getting-started/">Getting started</a>跑起来。不过为了理解其架构，我这里就不用官方的<code>all-in-one</code>启动了，而是将各个组件逐个部署启动起来。另外为了后面能整合ES搜索方案，我这里的storage使用了elasticsearch，这个jaeger也是支持的。下面的部署过程就直接贴docker-compose文件了，比较简单。</p>
<p><code>.env</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">COMPOSE_PROJECT_NAME<span style="color:#f92672">=</span>jaeger_demo
MY_HOST_IP<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>your_host_ip<span style="color:#e6db74">}</span>
</code></pre></div><p><code>docker-compose.yml</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">version: <span style="color:#e6db74">&#39;3&#39;</span>

services:
  elasticsearch:
    image: elasticsearch
    command: -Enode.name=jaegerESNode
    restart: always
    volumes:
      - <span style="color:#e6db74">&#34;esdata:/usr/share/elasticsearch/data&#34;</span>
    ports:
      - <span style="color:#e6db74">&#34;9200:9200&#34;</span>

  jaeger-collector:
    image: jaegertracing/jaeger-collector
    restart: always
    environment:
      SPAN_STORAGE_TYPE: elasticsearch
      ES_SERVER_URLS: http://${MY_HOST_IP:-<span style="color:#ae81ff">127.0</span><span style="color:#ae81ff">.0</span><span style="color:#ae81ff">.1</span>}:<span style="color:#ae81ff">9200</span>
    ports:
      - <span style="color:#e6db74">&#34;14267:14267&#34;</span>
      - <span style="color:#e6db74">&#34;14268:14268&#34;</span>
      - <span style="color:#e6db74">&#34;9411:9411&#34;</span>

  jaeger-query:
    image: jaegertracing/jaeger-query
    restart: always
    environment:
      SPAN_STORAGE_TYPE: elasticsearch
      ES_SERVER_URLS: http://${MY_HOST_IP:-<span style="color:#ae81ff">127.0</span><span style="color:#ae81ff">.0</span><span style="color:#ae81ff">.1</span>}:<span style="color:#ae81ff">9200</span>
    ports:
      - <span style="color:#e6db74">&#34;16686:16686&#34;</span>

  jaeger-agent:
    image: jaegertracing/jaeger-agent
    restart: always
    command: --collector.host-port=${MY_HOST_IP:-<span style="color:#ae81ff">127.0</span><span style="color:#ae81ff">.0</span><span style="color:#ae81ff">.1</span>}:<span style="color:#ae81ff">14267</span>
    ports:
      - <span style="color:#e6db74">&#34;5775:5775/udp&#34;</span>
      - <span style="color:#e6db74">&#34;6831:6831/udp&#34;</span>
      - <span style="color:#e6db74">&#34;6832:6832/udp&#34;</span>
      - <span style="color:#e6db74">&#34;5778:5778/tcp&#34;</span>
      
  jaeger-spark-dependencies:
    image: jaegertracing/spark-dependencies
    restart: always
    environment:
      STORAGE: elasticsearch
      ES_NODES: http://${MY_HOST_IP:-<span style="color:#ae81ff">127.0</span><span style="color:#ae81ff">.0</span><span style="color:#ae81ff">.1</span>}:<span style="color:#ae81ff">9200</span>
      ES_NODES_WAN_ONLY: <span style="color:#e6db74">&#39;true&#39;</span>
      JAVA_OPTS: -Dspark.testing.memory=<span style="color:#ae81ff">481859200</span>

  example-hotrod:
    image: jaegertracing/example-hotrod
    restart: always
    command: all --jaeger-agent.host-port=${MY_HOST_IP:-<span style="color:#ae81ff">127.0</span><span style="color:#ae81ff">.0</span><span style="color:#ae81ff">.1</span>}:<span style="color:#ae81ff">6831</span>
    ports:
      - <span style="color:#e6db74">&#34;8080-8083:8080-8083&#34;</span>

volumes:
  esdata:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: <span style="color:#e6db74">&#34;${PWD}/esdata&#34;</span>
</code></pre></div><p><code>docker-compose.yml</code>文件中配置的各个组件可按照jaeger的架构图部署在多台宿主机上，只要配置好正确的地址引用即可。</p>
<p>跑起来后访问<code>http://127.0.0.1:8080/</code>，点击不同的按钮，用以模拟不同的客户订购car。</p>
<p><img src="/images/20180722/1*tLGZLrpEE8gz6RZEVJRCbA.png" alt=""></p>
<p>然后访问<code>http://127.0.0.1:16686/</code>，即可查询调用链信息。</p>
<p><img src="/images/20180722/1*KXMjUpiQMMjXJjjK1GDAoA.png" alt=""></p>
<p><img src="/images/20180722/1*ph6PiyKcEXv42UP1BXhZMA.png" alt=""></p>
<p>基本功能大概就是这样了，一些强悍的功能可以查看<a href="https://medium.com/opentracing/take-opentracing-for-a-hotrod-ride-f6e3141f7941">这篇文章</a>。</p>
<h2 id="trace-instrumentation">Trace Instrumentation写法</h2>
<p>从jaeger的架构图中可以看到，微服务接入分布式调用追踪需要插入一些代码用于进行<code>Trace Instrumentation</code>。因为我们的项目大部分是go语言编写的，因此这里重点说一下go语言的Trace Instrumentation写法，其它语言应该类似。</p>
<h3 id="tracer">初始化Tracer</h3>
<p>根据相关的配置选项初始化Tracer，初始化方法可参考<code>https://github.com/jaegertracing/jaeger/blob/master/examples/hotrod/pkg/tracing/init.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Init creates a new instance of Jaeger tracer.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Init</span>(<span style="color:#a6e22e">serviceName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">metricsFactory</span> <span style="color:#a6e22e">metrics</span>.<span style="color:#a6e22e">Factory</span>, <span style="color:#a6e22e">logger</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Factory</span>, <span style="color:#a6e22e">backendHostPort</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Tracer</span> {
	<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Configuration</span>{
		<span style="color:#a6e22e">Sampler</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">SamplerConfig</span>{
			<span style="color:#a6e22e">Type</span>:  <span style="color:#e6db74">&#34;const&#34;</span>,
			<span style="color:#a6e22e">Param</span>: <span style="color:#ae81ff">1</span>,
		},
	}
	<span style="color:#75715e">// TODO(ys) a quick hack to ensure random generators get different seeds, which are based on current time.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
	<span style="color:#a6e22e">jaegerLogger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jaegerLoggerAdapter</span>{<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Bg</span>()}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sender</span> <span style="color:#a6e22e">jaeger</span>.<span style="color:#a6e22e">Transport</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">backendHostPort</span>, <span style="color:#e6db74">&#34;http://&#34;</span>) {
		<span style="color:#a6e22e">sender</span> = <span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">NewHTTPTransport</span>(
			<span style="color:#a6e22e">backendHostPort</span>,
			<span style="color:#a6e22e">transport</span>.<span style="color:#a6e22e">HTTPBatchSize</span>(<span style="color:#ae81ff">1</span>),
		)
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jaeger</span>.<span style="color:#a6e22e">NewUDPTransport</span>(<span style="color:#a6e22e">backendHostPort</span>, <span style="color:#ae81ff">0</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Bg</span>().<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;cannot initialize UDP sender&#34;</span>, <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>))
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">sender</span> = <span style="color:#a6e22e">s</span>
		}
	}
	<span style="color:#a6e22e">tracer</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">New</span>(
		<span style="color:#a6e22e">serviceName</span>,
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Reporter</span>(<span style="color:#a6e22e">jaeger</span>.<span style="color:#a6e22e">NewRemoteReporter</span>(
			<span style="color:#a6e22e">sender</span>,
			<span style="color:#a6e22e">jaeger</span>.<span style="color:#a6e22e">ReporterOptions</span>.<span style="color:#a6e22e">BufferFlushInterval</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>),
			<span style="color:#a6e22e">jaeger</span>.<span style="color:#a6e22e">ReporterOptions</span>.<span style="color:#a6e22e">Logger</span>(<span style="color:#a6e22e">jaegerLogger</span>),
		)),
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Logger</span>(<span style="color:#a6e22e">jaegerLogger</span>),
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Metrics</span>(<span style="color:#a6e22e">metricsFactory</span>),
		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Observer</span>(<span style="color:#a6e22e">rpcmetrics</span>.<span style="color:#a6e22e">NewObserver</span>(<span style="color:#a6e22e">metricsFactory</span>, <span style="color:#a6e22e">rpcmetrics</span>.<span style="color:#a6e22e">DefaultNameNormalizer</span>)),
	)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Bg</span>().<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;cannot initialize Jaeger Tracer&#34;</span>, <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>))
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tracer</span>
}
</code></pre></div><h3 id="httphandler">嵌入代码至http.Handler</h3>
<p>如果微服务是用HTTP提交的restful接口，则需要嵌入代码至http.Handler，可参考<code>https://github.com/jaegertracing/jaeger/blob/master/examples/hotrod/pkg/tracing/mux.go</code>，这里的主要处理逻辑在<code>https://github.com/opentracing-contrib/go-stdlib/blob/master/nethttp/server.go</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Handle implements http.ServeMux#Handle
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">tm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TracedServeMux</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">pattern</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) {
	<span style="color:#a6e22e">middleware</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nethttp</span>.<span style="color:#a6e22e">Middleware</span>(
		<span style="color:#a6e22e">tm</span>.<span style="color:#a6e22e">tracer</span>,
		<span style="color:#a6e22e">handler</span>,
		<span style="color:#a6e22e">nethttp</span>.<span style="color:#a6e22e">OperationNameFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) <span style="color:#66d9ef">string</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;HTTP &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Method</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">pattern</span>
		}))
	<span style="color:#a6e22e">tm</span>.<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">pattern</span>, <span style="color:#a6e22e">middleware</span>)
}
</code></pre></div><p>其实就是用nethttp包里的middleware将http.Handler包裹起来，可以猜测这个middleware的处理逻辑，如没有Trace的上下文信息，则创建一个全新的Trace，并将Trace的上下文信息放入请求处理上下文；如有Trace的上下文信息，则直接使用该Trace的上下文信息，并将Trace的上下文信息放入请求处理上下文。</p>
<h3 id="httpclient">嵌入代码至http.Client</h3>
<p>如果微服务是用http.Client调用其它微服务的restful接口，则需要嵌入代码至http.Client，可参考<code>https://github.com/jaegertracing/jaeger/blob/master/examples/hotrod/pkg/tracing/http.go</code>，这里的主要处理逻辑在<code>https://github.com/opentracing-contrib/go-stdlib/blob/master/nethttp/client.go</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// HTTPClient wraps an http.Client with tracing instrumentation.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HTTPClient</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Tracer</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Tracer</span>
	<span style="color:#a6e22e">Client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Client</span>
}

<span style="color:#75715e">// GetJSON executes HTTP GET against specified url and tried to parse
</span><span style="color:#75715e"></span><span style="color:#75715e">// the response into out object.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HTTPClient</span>) <span style="color:#a6e22e">GetJSON</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">endpoint</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">url</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">out</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#a6e22e">url</span>, <span style="color:#66d9ef">nil</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">req</span> = <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">WithContext</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">ht</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nethttp</span>.<span style="color:#a6e22e">TraceRequest</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Tracer</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">nethttp</span>.<span style="color:#a6e22e">OperationName</span>(<span style="color:#e6db74">&#34;HTTP GET: &#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">endpoint</span>))
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ht</span>.<span style="color:#a6e22e">Finish</span>()

	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">req</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">StatusCode</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">400</span> {
		<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ioutil</span>.<span style="color:#a6e22e">ReadAll</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Body</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(string(<span style="color:#a6e22e">body</span>))
	}
	<span style="color:#a6e22e">decoder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Body</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#a6e22e">out</span>)
}
</code></pre></div><p>其实就是用<code>nethttp.TraceRequest</code>方法来跟踪请求，同时将当前Trace的上下文信息传递给下一个微服务。</p>
<h3 id="spantag">给Span添加自定义tag</h3>
<p>可以给Span添加自定义tag，可参考<code>https://github.com/jaegertracing/jaeger/blob/master/examples/hotrod/services/customer/database.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// simulate opentracing instrumentation of an SQL query
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">span</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">SpanFromContext</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">span</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">span</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">tracer</span>.<span style="color:#a6e22e">StartSpan</span>(<span style="color:#e6db74">&#34;SQL SELECT&#34;</span>, <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">ChildOf</span>(<span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">Context</span>()))
		<span style="color:#a6e22e">tags</span>.<span style="color:#a6e22e">SpanKindRPCClient</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">span</span>)
		<span style="color:#a6e22e">tags</span>.<span style="color:#a6e22e">PeerService</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">span</span>, <span style="color:#e6db74">&#34;mysql&#34;</span>)
		<span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">SetTag</span>(<span style="color:#e6db74">&#34;sql.query&#34;</span>, <span style="color:#e6db74">&#34;SELECT * FROM customer WHERE customer_id=&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">customerID</span>)
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">Finish</span>()
		<span style="color:#a6e22e">ctx</span> = <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">ContextWithSpan</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">span</span>)
	}
</code></pre></div><p>这样在jaeger的UI上展开这个Span时，即可看到一些详细的信息。</p>
<p><img src="/images/20180722/image-20180722234642553.png" alt="image-20180722234642553"></p>
<h3 id="spanlog">给Span添加相关的log</h3>
<p>可以给Span添加自定义log，可参考<code>https://github.com/jaegertracing/jaeger/blob/master/examples/hotrod/pkg/log/spanlogger.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">spanLogger</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>
	<span style="color:#a6e22e">span</span>   <span style="color:#a6e22e">opentracing</span>.<span style="color:#a6e22e">Span</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sl</span> <span style="color:#a6e22e">spanLogger</span>) <span style="color:#a6e22e">Info</span>(<span style="color:#a6e22e">msg</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">fields</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">Field</span>) {
	<span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">logToSpan</span>(<span style="color:#e6db74">&#34;info&#34;</span>, <span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">fields</span><span style="color:#f92672">...</span>)
	<span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">fields</span><span style="color:#f92672">...</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sl</span> <span style="color:#a6e22e">spanLogger</span>) <span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">msg</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">fields</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">Field</span>) {
	<span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">logToSpan</span>(<span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">fields</span><span style="color:#f92672">...</span>)
	<span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">fields</span><span style="color:#f92672">...</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sl</span> <span style="color:#a6e22e">spanLogger</span>) <span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">msg</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">fields</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">Field</span>) {
	<span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">logToSpan</span>(<span style="color:#e6db74">&#34;fatal&#34;</span>, <span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">fields</span><span style="color:#f92672">...</span>)
	<span style="color:#a6e22e">tag</span>.<span style="color:#a6e22e">Error</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">span</span>, <span style="color:#66d9ef">true</span>)
	<span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">fields</span><span style="color:#f92672">...</span>)
}

<span style="color:#75715e">// With creates a child logger, and optionally adds some context fields to that logger.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sl</span> <span style="color:#a6e22e">spanLogger</span>) <span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">fields</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">Field</span>) <span style="color:#a6e22e">Logger</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">spanLogger</span>{<span style="color:#a6e22e">logger</span>: <span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">fields</span><span style="color:#f92672">...</span>), <span style="color:#a6e22e">span</span>: <span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">span</span>}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sl</span> <span style="color:#a6e22e">spanLogger</span>) <span style="color:#a6e22e">logToSpan</span>(<span style="color:#a6e22e">level</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">msg</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">fields</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">zapcore</span>.<span style="color:#a6e22e">Field</span>) {
	<span style="color:#75715e">// TODO rather than always converting the fields, we could wrap them into a lazy logger
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fa</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fieldAdapter</span>(make([]<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Field</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">+</span>len(<span style="color:#a6e22e">fields</span>)))
	<span style="color:#a6e22e">fa</span> = append(<span style="color:#a6e22e">fa</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;event&#34;</span>, <span style="color:#a6e22e">msg</span>))
	<span style="color:#a6e22e">fa</span> = append(<span style="color:#a6e22e">fa</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;level&#34;</span>, <span style="color:#a6e22e">level</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">field</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">fields</span> {
		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">AddTo</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">fa</span>)
	}
	<span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">LogFields</span>(<span style="color:#a6e22e">fa</span><span style="color:#f92672">...</span>)
}
</code></pre></div><p>在打日志的地址使用下面的语句</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">For</span>(<span style="color:#a6e22e">ctx</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Loading customer&#34;</span>, <span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;customer_id&#34;</span>, <span style="color:#a6e22e">customerID</span>))
</code></pre></div><p>这样在jaeger的UI里展开Span就可看到该Span相关的日志。</p>
<p><img src="/images/20180722/image-20180722235354858.png" alt="image-20180722235354858"></p>
<h3 id="trace-instrumentation-1">其它接口调用的Trace Instrumentation</h3>
<p>除了常规restful接口，其它类型如何做Trace Instrumentation可参考<a href="https://github.com/opentracing-contrib?utf8=%E2%9C%93&amp;q=&amp;type=&amp;language=go">opentracing-contrib</a>。</p>
<h2 id="jaeger">jaeger的源码解析</h2>
<p>简单浏览下jaeger的源码，整体逻辑还是比较清晰的，通过阅读它的源码还是学到了不少coding技巧的。在网上还找到一位小哥写的jaeger源码解析，写得还挺详细的，这里就不赘述了，直接参考<a href="https://github.com/jukylin/blog/">jaeger源码解析</a>就可以了。</p>
<p>THE END</p>
<h2 id="heading-6">参考</h2>
<ol>
<li><a href="https://medium.com/opentracing/take-opentracing-for-a-hotrod-ride-f6e3141f7941">https://medium.com/opentracing/take-opentracing-for-a-hotrod-ride-f6e3141f7941</a></li>
<li><a href="https://www.jaegertracing.io/">https://www.jaegertracing.io/</a></li>
<li><a href="https://zipkin.io/">https://zipkin.io/</a></li>
<li><a href="http://research.google.com/pubs/pub36356.html">http://research.google.com/pubs/pub36356.html</a></li>
<li><a href="https://sematext.com/blog/jaeger-vs-zipkin-opentracing-distributed-tracers/">https://sematext.com/blog/jaeger-vs-zipkin-opentracing-distributed-tracers/</a></li>
<li><a href="http://opentracing.io/documentation/">http://opentracing.io/documentation/</a></li>
</ol>

    </div>

    
    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Jeremy Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2018-07-22</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">&copy; Copyright 2020 Jeremy Xu</span>
  </p>
</div>

    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/wechat-qr-code.png">
        <span>微信打赏</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/alipay-qr-code.png">
        <span>支付宝打赏</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/golang/">golang</a>
          
          <a href="/tags/jaeger/">jaeger</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/2018/08/%E7%A0%94%E7%A9%B6%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E4%B9%8Bprometheus/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">研究监控系统之prometheus</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/2018/07/%E7%A0%94%E7%A9%B6consul%E7%9A%84service-mesh%E5%8A%9F%E8%83%BD/">
            <span class="next-text nav-default">研究consul的service mesh功能</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        


<div id="utter-container"></div>
<script src="https://utteranc.es/client.js" repo='jeremyxu2010/blog_comment'
  issue-term="title" theme='github-light' crossorigin="anonymous" async>
  </script>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:jeremyxu2010@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://plus.google.com/u/0/103057094241630654183" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/jeremyxu2010" class="iconfont icon-github" title="github"></a>
  <a href="https://jeremyxu2010.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2016 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">&copy; Copyright 2019 Jeremy Xu</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.min.js?v=3.1.1"></script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\[\[','\]\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
           extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
  
  MathJax.Hub.Queue(function() {
      
      
      
      var all = MathJax.Hub.getAllJax(), i;
      for(i = 0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
  </script>








<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.0/fuse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
<script src="https://jeremyxu2010.github.io/js/search.js"></script>


</body>
</html>
