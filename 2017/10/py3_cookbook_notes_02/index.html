<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>py3_cookbook_notes_02 - jeremy的技术点滴</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="徐新杰" />
  <meta name="description" content="最近在看Python Cookbook第三版，将看书过程中一些平时不太容易注意的知识点记录下来。 函数 可接受任意数量参数的函数 def avg(first, *rest): return (first &#43; sum(rest)) / (1" />




<meta name="google-site-verification" content="Ol4gI1XKZ2qsa-efwwJvaGeDyXb91RL-pZBv-3uyY-A" />


<meta name="generator" content="Hugo " />


<link rel="canonical" href="https://jeremyxu2010.github.io/2017/10/py3_cookbook_notes_02/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.1.1" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">



<link rel="stylesheet" href="/css/mathjax.css">


<meta property="og:title" content="py3_cookbook_notes_02" />
<meta property="og:description" content="最近在看Python Cookbook第三版，将看书过程中一些平时不太容易注意的知识点记录下来。 函数 可接受任意数量参数的函数 def avg(first, *rest): return (first &#43; sum(rest)) / (1" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jeremyxu2010.github.io/2017/10/py3_cookbook_notes_02/" />
<meta property="article:published_time" content="2017-10-07T12:12:00+08:00" />
<meta property="article:modified_time" content="2017-10-07T12:12:00+08:00" />
<meta itemprop="name" content="py3_cookbook_notes_02">
<meta itemprop="description" content="最近在看Python Cookbook第三版，将看书过程中一些平时不太容易注意的知识点记录下来。 函数 可接受任意数量参数的函数 def avg(first, *rest): return (first &#43; sum(rest)) / (1">
<meta itemprop="datePublished" content="2017-10-07T12:12:00&#43;08:00" />
<meta itemprop="dateModified" content="2017-10-07T12:12:00&#43;08:00" />
<meta itemprop="wordCount" content="7573">



<meta itemprop="keywords" content="python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="py3_cookbook_notes_02"/>
<meta name="twitter:description" content="最近在看Python Cookbook第三版，将看书过程中一些平时不太容易注意的知识点记录下来。 函数 可接受任意数量参数的函数 def avg(first, *rest): return (first &#43; sum(rest)) / (1"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">jeremy的技术点滴</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/search/">
        <li class="mobile-menu-item">Search</li>
      </a>
  </ul>
</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">jeremy的技术点滴</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/search/">Search</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">py3_cookbook_notes_02</h1>

      <div class="post-meta">
        <span class="post-time"> 2017-10-07 </span>
        <div class="post-category">
            
              <a href="/categories/python%E5%BC%80%E5%8F%91/"> python开发 </a>
            
          </div>
        <span class="more-meta"> 约 7573 字 </span>
        <span class="more-meta"> 预计阅读 16 分钟 </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#heading">函数</a>
      <ul>
        <li><a href="#heading-1">可接受任意数量参数的函数</a></li>
        <li><a href="#heading-2">只接受关键字参数的函数</a></li>
        <li><a href="#heading-3">给函数参数增加元信息</a></li>
        <li><a href="#heading-4">定义匿名或内联函数</a></li>
        <li><a href="#heading-5">匿名函数捕获变量值</a></li>
        <li><a href="#heading-6">减少可调用对象的参数个数</a></li>
        <li><a href="#heading-7">将单方法的类转换为函数</a></li>
        <li><a href="#heading-8">带额外状态信息的回调函数</a></li>
        <li><a href="#heading-9">内联回调函数</a></li>
        <li><a href="#heading-10">访问闭包中定义的变量</a></li>
      </ul>
    </li>
    <li><a href="#heading-11">类与对象</a>
      <ul>
        <li><a href="#heading-12">改变对象的字符串显示</a></li>
        <li><a href="#heading-13">自定义字符串的格式化</a></li>
        <li><a href="#heading-14">让对象支持上下文管理协议</a></li>
        <li><a href="#heading-15">在类中封装属性名</a></li>
        <li><a href="#heading-16">创建可管理的属性</a></li>
        <li><a href="#heading-17">调用父类方法</a></li>
        <li><a href="#heading-18">简化数据结构的初始化</a></li>
        <li><a href="#heading-19">定义接口或者抽象基类</a></li>
        <li><a href="#heading-20">实现数据模型的类型约束</a></li>
        <li><a href="#heading-21">实现自定义容器</a></li>
        <li><a href="#heading-22">属性的代理访问</a></li>
        <li><a href="#heading-23">在类中定义多个构造器</a></li>
        <li><a href="#init">创建不调用init方法的实例</a></li>
        <li><a href="#heading-24">有用的方法扩展其他类的功能</a></li>
        <li><a href="#heading-25">实现状态对象或者状态机</a></li>
        <li><a href="#heading-26">通过字符串调用对象方法</a></li>
        <li><a href="#heading-27">实现访问者模式(递归实现法)</a></li>
        <li><a href="#heading-28">实现访问者模式(非递归实现法)</a></li>
        <li><a href="#heading-29">循环引用数据结构的内存管理</a></li>
        <li><a href="#heading-30">让类支持比较操作</a></li>
        <li><a href="#heading-31">创建缓存实例</a></li>
      </ul>
    </li>
    <li><a href="#heading-32">元编程</a>
      <ul>
        <li><a href="#heading-33">在函数上添加包装器</a></li>
        <li><a href="#heading-34">带可选参数的装饰器</a></li>
        <li><a href="#heading-35">利用装饰器强制函数上的类型检查</a></li>
        <li><a href="#heading-36">将装饰器定义为类</a></li>
        <li><a href="#heading-37">装饰器为被包装函数增加参数</a></li>
        <li><a href="#heading-38">使用装饰器扩充类的功能</a></li>
        <li><a href="#heading-39">使用元类控制实例的创建</a></li>
        <li><a href="#heading-40">捕获类的属性定义顺序</a></li>
        <li><a href="#heading-41">定义有可选参数的元类</a></li>
        <li><a href="#argskwargs">args和kwargs的强制参数签名</a></li>
        <li><a href="#heading-42">在类上强制使用编程规约</a></li>
        <li><a href="#heading-43">以编程方式定义类</a></li>
        <li><a href="#heading-44">在定义的时候初始化类的成员</a></li>
        <li><a href="#heading-45">避免重复的属性方法</a></li>
        <li><a href="#heading-46">定义上下文管理器的简单方法</a></li>
        <li><a href="#heading-47">在局部变量域中执行代码</a></li>
      </ul>
    </li>
    <li><a href="#heading-48">模块与包</a>
      <ul>
        <li><a href="#heading-49">控制模块被全部导入的内容</a></li>
        <li><a href="#heading-50">使用相对路径名导入包中子模块</a></li>
        <li><a href="#heading-51">将模块分割成多个文件</a></li>
        <li><a href="#heading-52">利用命名空间导入目录分散的代码</a></li>
        <li><a href="#heading-53">运行目录或压缩文件</a></li>
        <li><a href="#heading-54">读取位于包中的数据文件</a></li>
        <li><a href="#syspath">将文件夹加入到sys.path</a></li>
        <li><a href="#heading-55">通过字符串名导入模块</a></li>
        <li><a href="#heading-56">安装私有的包</a></li>
        <li><a href="#python">创建新的Python环境</a></li>
        <li><a href="#heading-57">分发包</a></li>
      </ul>
    </li>
    <li><a href="#web">网络与Web编程</a>
      <ul>
        <li><a href="#http">作为客户端与HTTP服务交互</a></li>
        <li><a href="#tcp">创建TCP服务器</a></li>
        <li><a href="#udp">创建UDP服务器</a></li>
        <li><a href="#cidrip">通过CIDR地址生成对应的IP地址集</a></li>
        <li><a href="#xml-rpc">通过XML-RPC实现简单的远程调用</a></li>
        <li><a href="#python-1">在不同的Python解释器之间交互</a></li>
        <li><a href="#heading-58">简单的客户端认证</a></li>
        <li><a href="#ssl">在网络服务中加入SSL</a></li>
        <li><a href="#io">理解事件驱动的IO</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>最近在看<a href="http://python3-cookbook.readthedocs.io/zh_CN/latest/">Python Cookbook第三版</a>，将看书过程中一些平时不太容易注意的知识点记录下来。</p>
<h2 id="heading">函数</h2>
<h3 id="heading-1">可接受任意数量参数的函数</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">avg</span>(first, <span style="color:#f92672">*</span>rest):
    <span style="color:#66d9ef">return</span> (first <span style="color:#f92672">+</span> sum(rest)) <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> len(rest))

<span style="color:#75715e"># Sample use</span>
avg(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>) <span style="color:#75715e"># 1.5</span>
avg(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>) <span style="color:#75715e"># 2.5</span>

<span style="color:#f92672">import</span> html

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_element</span>(name, value, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>attrs):
    keyvals <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> item <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> attrs<span style="color:#f92672">.</span>items()]
    attr_str <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(keyvals)
    element <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&lt;{name}{attrs}&gt;{value}&lt;/{name}&gt;</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(
                name<span style="color:#f92672">=</span>name,
                attrs<span style="color:#f92672">=</span>attr_str,
                value<span style="color:#f92672">=</span>html<span style="color:#f92672">.</span>escape(value))
    <span style="color:#66d9ef">return</span> element

<span style="color:#75715e"># Example</span>
<span style="color:#75715e"># Creates &#39;&lt;item size=&#34;large&#34; quantity=&#34;6&#34;&gt;Albatross&lt;/item&gt;&#39;</span>
make_element(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">item</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Albatross</span><span style="color:#e6db74">&#39;</span>, size<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">large</span><span style="color:#e6db74">&#39;</span>, quantity<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)

<span style="color:#75715e"># Creates &#39;&lt;p&gt;&amp;lt;spam&amp;gt;&lt;/p&gt;&#39;</span>
make_element(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">p</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&lt;spam&gt;</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><h3 id="heading-2">只接受关键字参数的函数</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recv</span>(maxsize, <span style="color:#f92672">*</span>, block):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Receives a message</span><span style="color:#e6db74">&#39;</span>
    <span style="color:#66d9ef">pass</span>

recv(<span style="color:#ae81ff">1024</span>, True) <span style="color:#75715e"># TypeError</span>
recv(<span style="color:#ae81ff">1024</span>, block<span style="color:#f92672">=</span>True) <span style="color:#75715e"># Ok</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mininum</span>(<span style="color:#f92672">*</span>values, clip<span style="color:#f92672">=</span>None):
    m <span style="color:#f92672">=</span> min(values)
    <span style="color:#66d9ef">if</span> clip <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
        m <span style="color:#f92672">=</span> clip <span style="color:#66d9ef">if</span> clip <span style="color:#f92672">&gt;</span> m <span style="color:#66d9ef">else</span> m
    <span style="color:#66d9ef">return</span> m

minimum(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>) <span style="color:#75715e"># Returns -5</span>
minimum(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, clip<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>) <span style="color:#75715e"># Returns 0</span>
</code></pre></div><h3 id="heading-3">给函数参数增加元信息</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x:int, y:int) <span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span> int:
    <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y
</code></pre></div><h3 id="heading-4">定义匿名或内联函数</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> add <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x, y: x <span style="color:#f92672">+</span> y
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> add(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>)
<span style="color:#ae81ff">5</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> add(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">hello</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">world</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">helloworld</span><span style="color:#e6db74">&#39;</span>

<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> names <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">David Beazley</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Brian Jones</span><span style="color:#e6db74">&#39;</span>,
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>         <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Raymond Hettinger</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Ned Batchelder</span><span style="color:#e6db74">&#39;</span>]
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> sorted(names, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> name: name<span style="color:#f92672">.</span>split()[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>lower())
[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Ned Batchelder</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">David Beazley</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Raymond Hettinger</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Brian Jones</span><span style="color:#e6db74">&#39;</span>]
</code></pre></div><h3 id="heading-5">匿名函数捕获变量值</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> a <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> y, x<span style="color:#f92672">=</span>x: x <span style="color:#f92672">+</span> y
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> b <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> y, x<span style="color:#f92672">=</span>x: x <span style="color:#f92672">+</span> y
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> a(<span style="color:#ae81ff">10</span>)
<span style="color:#ae81ff">20</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> b(<span style="color:#ae81ff">10</span>)
<span style="color:#ae81ff">30</span>
</code></pre></div><h3 id="heading-6">减少可调用对象的参数个数</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>(a, b, c, d):
    <span style="color:#66d9ef">print</span>(a, b, c, d)
    
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> partial
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s1 <span style="color:#f92672">=</span> partial(spam, <span style="color:#ae81ff">1</span>) <span style="color:#75715e"># a = 1</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s1(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>)
<span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">4</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s2 <span style="color:#f92672">=</span> partial(spam, d<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>) <span style="color:#75715e"># d = 42</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s2(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>)
<span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">42</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s2(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">5</span>)
<span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">42</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s3 <span style="color:#f92672">=</span> partial(spam, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, d<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>) <span style="color:#75715e"># a = 1, b = 2, d = 42</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s3(<span style="color:#ae81ff">3</span>)
</code></pre></div><h3 id="heading-7">将单方法的类转换为函数</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> urllib.request <span style="color:#f92672">import</span> urlopen

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UrlTemplate</span>:
    <span style="color:#66d9ef">def</span> __init__(self, template):
        self<span style="color:#f92672">.</span>template <span style="color:#f92672">=</span> template

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">open</span>(self, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        <span style="color:#66d9ef">return</span> urlopen(self<span style="color:#f92672">.</span>template<span style="color:#f92672">.</span>format_map(kwargs))

<span style="color:#75715e"># Example use. Download stock data from yahoo</span>
yahoo <span style="color:#f92672">=</span> UrlTemplate(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://finance.yahoo.com/d/quotes.csv?s={names}&amp;f={fields}</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> yahoo<span style="color:#f92672">.</span>open(names<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">IBM,AAPL,FB</span><span style="color:#e6db74">&#39;</span>, fields<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">sl1c1v</span><span style="color:#e6db74">&#39;</span>):
    <span style="color:#66d9ef">print</span>(line<span style="color:#f92672">.</span>decode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">utf-8</span><span style="color:#e6db74">&#39;</span>))
</code></pre></div><p>转换写法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> urllib.request <span style="color:#f92672">import</span> urlopen

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">urltemplate</span>(template):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">opener</span>(<span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        <span style="color:#66d9ef">return</span> urlopen(template<span style="color:#f92672">.</span>format_map(kwargs))
    <span style="color:#66d9ef">return</span> opener

<span style="color:#75715e"># Example use</span>
yahoo <span style="color:#f92672">=</span> urltemplate(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://finance.yahoo.com/d/quotes.csv?s={names}&amp;f={fields}</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> yahoo(names<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">IBM,AAPL,FB</span><span style="color:#e6db74">&#39;</span>, fields<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">sl1c1v</span><span style="color:#e6db74">&#39;</span>):
    <span style="color:#66d9ef">print</span>(line<span style="color:#f92672">.</span>decode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">utf-8</span><span style="color:#e6db74">&#39;</span>))
</code></pre></div><h3 id="heading-8">带额外状态信息的回调函数</h3>
<p>3种解决方法：</p>
<ul>
<li>创建一个类的实例</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x, y):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ResultHandler</span>:

    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>sequence <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handler</span>(self, result):
        self<span style="color:#f92672">.</span>sequence <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">[{}] Got: {}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>sequence, result))

<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> r <span style="color:#f92672">=</span> ResultHandler()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> apply_async(add, (<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>), callback<span style="color:#f92672">=</span>r<span style="color:#f92672">.</span>handler)
[<span style="color:#ae81ff">1</span>] Got: <span style="color:#ae81ff">5</span>
</code></pre></div><ul>
<li>用一个闭包捕获状态值</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x, y):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_handler</span>():
    sequence <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handler</span>(result):
        nonlocal sequence
        sequence <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">[{}] Got: {}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(sequence, result))
    <span style="color:#66d9ef">return</span> handler
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> handler <span style="color:#f92672">=</span> make_handler()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> apply_async(add, (<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>), callback<span style="color:#f92672">=</span>handler)
</code></pre></div><h3 id="heading-9">内联回调函数</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">apply_async</span>(func, args, <span style="color:#f92672">*</span>, callback):
    <span style="color:#75715e"># Compute the result</span>
    result <span style="color:#f92672">=</span> func(<span style="color:#f92672">*</span>args)

    <span style="color:#75715e"># Invoke the callback with the result</span>
    callback(result)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Async</span>:
    <span style="color:#66d9ef">def</span> __init__(self, func, args):
        self<span style="color:#f92672">.</span>func <span style="color:#f92672">=</span> func
        self<span style="color:#f92672">.</span>args <span style="color:#f92672">=</span> args

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">inlined_async</span>(func):
    <span style="color:#a6e22e">@wraps</span>(func)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args):
        f <span style="color:#f92672">=</span> func(<span style="color:#f92672">*</span>args) <span style="color:#75715e"># func is test function, f is a generator</span>
        result_queue <span style="color:#f92672">=</span> Queue()
        result_queue<span style="color:#f92672">.</span>put(None)
        <span style="color:#66d9ef">while</span> True:
            result <span style="color:#f92672">=</span> result_queue<span style="color:#f92672">.</span>get()
            <span style="color:#66d9ef">try</span>:
                a <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>send(result) <span style="color:#75715e"># a is Async object</span>
                apply_async(a<span style="color:#f92672">.</span>func, a<span style="color:#f92672">.</span>args, callback<span style="color:#f92672">=</span>result_queue<span style="color:#f92672">.</span>put)
            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">StopIteration</span>:
                <span style="color:#66d9ef">break</span>
    <span style="color:#66d9ef">return</span> wrapper

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x, y):
    <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y

<span style="color:#a6e22e">@inlined_async</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
    r <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span> Async(add, (<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>))
    <span style="color:#66d9ef">print</span>(r)
    r <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span> Async(add, (<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">hello</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">world</span><span style="color:#e6db74">&#39;</span>))
    <span style="color:#66d9ef">print</span>(r)
    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
        r <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span> Async(add, (n, n))
        <span style="color:#66d9ef">print</span>(r)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Goodbye</span><span style="color:#e6db74">&#39;</span>)

test()
</code></pre></div><p>这里特别解释一下操作generator的两个方法<code>send</code>和<code>next</code>：</p>
<p><a href="https://stackoverflow.com/questions/12637768/python-3-send-method-of-generators">https://stackoverflow.com/questions/12637768/python-3-send-method-of-generators</a></p>
<blockquote>
<p>When you use <code>send</code> and expression <code>yield</code> in a generator, you're treating it as a coroutine; a separate thread of execution that can run sequentially interleaved but not in parallel with its caller.</p>
<p>When the caller executes <code>R = m.send(a)</code>, it puts the object <code>a</code> into the generator's input slot, transfers control to the generator, and waits for a response. The generator receives object <code>a</code> as the result of <code>X = yield i</code>, and runs until it hits another <code>yield</code> expression e.g. <code>Y = yield j</code>. Then it puts <code>j</code> into its output slot, transfers control back to the caller, and waits until it gets resumed again. The caller receives <code>j</code> as the result of <code>R = m.send(a)</code>, and runs until it hits another <code>S = m.send(b)</code> statement, and so on.</p>
<p><code>R = next(m)</code> is just the same as <code>R = m.send(None)</code>; it's putting <code>None</code> into the generator's input slot, so if the generator checks the result of <code>X = yield i</code> then <code>X</code> will be <code>None</code>.</p>
</blockquote>
<h3 id="heading-10">访问闭包中定义的变量</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sample</span>():
    n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#75715e"># Closure function</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">func</span>():
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">n=</span><span style="color:#e6db74">&#39;</span>, n)

    <span style="color:#75715e"># Accessor methods for n</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_n</span>():
        <span style="color:#66d9ef">return</span> n

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_n</span>(value):
        nonlocal n
        n <span style="color:#f92672">=</span> value

    <span style="color:#75715e"># Attach as function attributes</span>
    func<span style="color:#f92672">.</span>get_n <span style="color:#f92672">=</span> get_n
    func<span style="color:#f92672">.</span>set_n <span style="color:#f92672">=</span> set_n
    <span style="color:#66d9ef">return</span> func
</code></pre></div><h2 id="heading-11">类与对象</h2>
<h3 id="heading-12">改变对象的字符串显示</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Pair</span>:
    <span style="color:#66d9ef">def</span> __init__(self, x, y):
        self<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> x
        self<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> y

    <span style="color:#66d9ef">def</span> __repr__(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Pair({0.x!r}, {0.y!r})</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(self)

    <span style="color:#66d9ef">def</span> __str__(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">({0.x!s}, {0.y!s})</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(self)
</code></pre></div><h3 id="heading-13">自定义字符串的格式化</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">_formats <span style="color:#f92672">=</span> {
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ymd</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{d.year}-{d.month}-{d.day}</span><span style="color:#e6db74">&#39;</span>,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">mdy</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{d.month}/{d.day}/{d.year}</span><span style="color:#e6db74">&#39;</span>,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">dmy</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{d.day}/{d.month}/{d.year}</span><span style="color:#e6db74">&#39;</span>
    }

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Date</span>:
    <span style="color:#66d9ef">def</span> __init__(self, year, month, day):
        self<span style="color:#f92672">.</span>year <span style="color:#f92672">=</span> year
        self<span style="color:#f92672">.</span>month <span style="color:#f92672">=</span> month
        self<span style="color:#f92672">.</span>day <span style="color:#f92672">=</span> day

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__format__</span>(self, code):
        <span style="color:#66d9ef">if</span> code <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>:
            code <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ymd</span><span style="color:#e6db74">&#39;</span>
        fmt <span style="color:#f92672">=</span> _formats[code]
        <span style="color:#66d9ef">return</span> fmt<span style="color:#f92672">.</span>format(d<span style="color:#f92672">=</span>self)
      
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> d <span style="color:#f92672">=</span> Date(<span style="color:#ae81ff">2012</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">21</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> format(d)
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">2012-12-21</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> format(d, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">mdy</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">12/21/2012</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">The date is {:ymd}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(d)
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">The date is 2012-12-21</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">The date is {:mdy}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(d)
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">The date is 12/21/2012</span><span style="color:#e6db74">&#39;</span>
</code></pre></div><h3 id="heading-14">让对象支持上下文管理协议</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> socket <span style="color:#f92672">import</span> socket, AF_INET, SOCK_STREAM

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LazyConnection</span>:
    <span style="color:#66d9ef">def</span> __init__(self, address, family<span style="color:#f92672">=</span>AF_INET, type<span style="color:#f92672">=</span>SOCK_STREAM):
        self<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> address
        self<span style="color:#f92672">.</span>family <span style="color:#f92672">=</span> family
        self<span style="color:#f92672">.</span>type <span style="color:#f92672">=</span> type
        self<span style="color:#f92672">.</span>sock <span style="color:#f92672">=</span> None

    <span style="color:#66d9ef">def</span> __enter__(self):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>sock <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Already connected</span><span style="color:#e6db74">&#39;</span>)
        self<span style="color:#f92672">.</span>sock <span style="color:#f92672">=</span> socket(self<span style="color:#f92672">.</span>family, self<span style="color:#f92672">.</span>type)
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>connect(self<span style="color:#f92672">.</span>address)
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>sock

    <span style="color:#66d9ef">def</span> __exit__(self, exc_ty, exc_val, tb):
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>close()
        self<span style="color:#f92672">.</span>sock <span style="color:#f92672">=</span> None
        
<span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> partial

conn <span style="color:#f92672">=</span> LazyConnection((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">www.python.org</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">80</span>))
<span style="color:#75715e"># Connection closed</span>
<span style="color:#66d9ef">with</span> conn <span style="color:#66d9ef">as</span> s:
    <span style="color:#75715e"># conn.__enter__() executes: connection open</span>
    s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">GET /index.html HTTP/1.0</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
    s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Host: www.python.org</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
    s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
    resp <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(iter(partial(s<span style="color:#f92672">.</span>recv, <span style="color:#ae81ff">8192</span>), <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>))
    <span style="color:#75715e"># conn.__exit__() executes: connection closed</span>
</code></pre></div><h3 id="heading-15">在类中封装属性名</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>:
    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>_internal <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#75715e"># An internal attribute</span>
        self<span style="color:#f92672">.</span>public <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e"># A public attribute</span>
        self<span style="color:#f92672">.</span>__private_field <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#75715e"># 不能被子类覆盖</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">public_method</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        A public method</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#39;&#39;&#39;</span>
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_internal_method</span>(self):
        <span style="color:#66d9ef">pass</span>
      
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__private_method</span>(self):
        <span style="color:#66d9ef">pass</span>
</code></pre></div><h3 id="heading-16">创建可管理的属性</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Person</span>:
    <span style="color:#66d9ef">def</span> __init__(self, first_name):
        self<span style="color:#f92672">.</span>first_name <span style="color:#f92672">=</span> first_name

    <span style="color:#75715e"># Getter function</span>
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">first_name</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_first_name

    <span style="color:#75715e"># Setter function</span>
    <span style="color:#a6e22e">@first_name.setter</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">first_name</span>(self, value):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(value, str):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Expected a string</span><span style="color:#e6db74">&#39;</span>)
        self<span style="color:#f92672">.</span>_first_name <span style="color:#f92672">=</span> value

    <span style="color:#75715e"># Deleter function (optional)</span>
    <span style="color:#a6e22e">@first_name.deleter</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">first_name</span>(self):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">AttributeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">t delete attribute</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><h3 id="heading-17">调用父类方法</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">A.spam</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span>(A):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">B.spam</span><span style="color:#e6db74">&#39;</span>)
        super()<span style="color:#f92672">.</span>spam()  <span style="color:#75715e"># Call parent spam()</span>
</code></pre></div><h3 id="heading-18">简化数据结构的初始化</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Structure</span>:
    <span style="color:#75715e"># Class variable that specifies expected fields</span>
    _fields <span style="color:#f92672">=</span> []

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        <span style="color:#66d9ef">if</span> len(args) <span style="color:#f92672">!=</span> len(self<span style="color:#f92672">.</span>_fields):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Expected {} arguments</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(len(self<span style="color:#f92672">.</span>_fields)))

        <span style="color:#75715e"># Set the arguments</span>
        <span style="color:#66d9ef">for</span> name, value <span style="color:#f92672">in</span> zip(self<span style="color:#f92672">.</span>_fields, args):
            setattr(self, name, value)

        <span style="color:#75715e"># Set the additional arguments (if any)</span>
        extra_args <span style="color:#f92672">=</span> kwargs<span style="color:#f92672">.</span>keys() <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>_fields
        <span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> extra_args:
            setattr(self, name, kwargs<span style="color:#f92672">.</span>pop(name))

        <span style="color:#66d9ef">if</span> kwargs:
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Duplicate values for {}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">,</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(kwargs)))
            
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stock</span>(Structure):
        _fields <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">shares</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">price</span><span style="color:#e6db74">&#39;</span>]

    s1 <span style="color:#f92672">=</span> Stock(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ACME</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">91.1</span>)
    s2 <span style="color:#f92672">=</span> Stock(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ACME</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">91.1</span>, date<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">8/2/2012</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><h3 id="heading-19">定义接口或者抽象基类</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IStream</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):
    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>(self, maxbytes<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write</span>(self, data):
        <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SocketStream</span>(IStream):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>(self, maxbytes<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write</span>(self, data):
        <span style="color:#66d9ef">pass</span>

<span style="color:#75715e"># Register the built-in I/O classes as supporting our interface</span>
<span style="color:#f92672">import</span> io
IStream<span style="color:#f92672">.</span>register(io<span style="color:#f92672">.</span>IOBase)

<span style="color:#f92672">import</span> collections

<span style="color:#75715e"># Check if x is a sequence</span>
<span style="color:#66d9ef">if</span> isinstance(x, collections<span style="color:#f92672">.</span>Sequence):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>

<span style="color:#75715e"># Check if x is iterable</span>
<span style="color:#66d9ef">if</span> isinstance(x, collections<span style="color:#f92672">.</span>Iterable):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>

<span style="color:#75715e"># Check if x has a size</span>
<span style="color:#66d9ef">if</span> isinstance(x, collections<span style="color:#f92672">.</span>Sized):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>

<span style="color:#75715e"># Check if x is a mapping</span>
<span style="color:#66d9ef">if</span> isinstance(x, collections<span style="color:#f92672">.</span>Mapping):
</code></pre></div><h3 id="heading-20">实现数据模型的类型约束</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Base class. Uses a descriptor to set a value</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Descriptor</span>:
    <span style="color:#66d9ef">def</span> __init__(self, name<span style="color:#f92672">=</span>None, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>opts):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> opts<span style="color:#f92672">.</span>items():
            setattr(self, key, value)

    <span style="color:#66d9ef">def</span> __set__(self, instance, value):
        instance<span style="color:#f92672">.</span>__dict__[self<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> value


<span style="color:#75715e"># Descriptor for enforcing types</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Typed</span>(Descriptor):
    expected_type <span style="color:#f92672">=</span> type(None)

    <span style="color:#66d9ef">def</span> __set__(self, instance, value):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(value, self<span style="color:#f92672">.</span>expected_type):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">expected </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(self<span style="color:#f92672">.</span>expected_type))
        super()<span style="color:#f92672">.</span>__set__(instance, value)


<span style="color:#75715e"># Descriptor for enforcing values</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Unsigned</span>(Descriptor):
    <span style="color:#66d9ef">def</span> __set__(self, instance, value):
        <span style="color:#66d9ef">if</span> value <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Expected &gt;= 0</span><span style="color:#e6db74">&#39;</span>)
        super()<span style="color:#f92672">.</span>__set__(instance, value)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MaxSized</span>(Descriptor):
    <span style="color:#66d9ef">def</span> __init__(self, name<span style="color:#f92672">=</span>None, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>opts):
        <span style="color:#66d9ef">if</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">size</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> opts:
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">missing size option</span><span style="color:#e6db74">&#39;</span>)
        super()<span style="color:#f92672">.</span>__init__(name, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>opts)

    <span style="color:#66d9ef">def</span> __set__(self, instance, value):
        <span style="color:#66d9ef">if</span> len(value) <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>size:
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">size must be &lt; </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(self<span style="color:#f92672">.</span>size))
        super()<span style="color:#f92672">.</span>__set__(instance, value)
        
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Integer</span>(Typed):
    expected_type <span style="color:#f92672">=</span> int

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnsignedInteger</span>(Integer, Unsigned):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Float</span>(Typed):
    expected_type <span style="color:#f92672">=</span> float

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnsignedFloat</span>(Float, Unsigned):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">String</span>(Typed):
    expected_type <span style="color:#f92672">=</span> str

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SizedString</span>(String, MaxSized):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stock</span>:
    <span style="color:#75715e"># Specify constraints</span>
    name <span style="color:#f92672">=</span> SizedString(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name</span><span style="color:#e6db74">&#39;</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>)
    shares <span style="color:#f92672">=</span> UnsignedInteger(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">shares</span><span style="color:#e6db74">&#39;</span>)
    price <span style="color:#f92672">=</span> UnsignedFloat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">price</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#66d9ef">def</span> __init__(self, name, shares, price):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>shares <span style="color:#f92672">=</span> shares
        self<span style="color:#f92672">.</span>price <span style="color:#f92672">=</span> price
</code></pre></div><h3 id="heading-21">实现自定义容器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> collections
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>(collections<span style="color:#f92672">.</span>Iterable):
    <span style="color:#66d9ef">def</span> __iter__():
      <span style="color:#66d9ef">pass</span>
</code></pre></div><h3 id="heading-22">属性的代理访问</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>(self, x):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(self):
        <span style="color:#66d9ef">pass</span>
      
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B2</span>:
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">使用__getattr__的代理，代理方法比较多时候</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>_a <span style="color:#f92672">=</span> A()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bar</span>(self):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#75715e"># Expose all of the methods defined on class A</span>
    <span style="color:#66d9ef">def</span> __getattr__(self, name):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">这个方法在访问的attribute不存在的时候被调用</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        the __getattr__() method is actually a fallback method</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        that only gets called when an attribute is not found</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> getattr(self<span style="color:#f92672">.</span>_a, name)
</code></pre></div><h3 id="heading-23">在类中定义多个构造器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> time

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Date</span>:
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">方法一：使用类方法</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    <span style="color:#75715e"># Primary constructor</span>
    <span style="color:#66d9ef">def</span> __init__(self, year, month, day):
        self<span style="color:#f92672">.</span>year <span style="color:#f92672">=</span> year
        self<span style="color:#f92672">.</span>month <span style="color:#f92672">=</span> month
        self<span style="color:#f92672">.</span>day <span style="color:#f92672">=</span> day

    <span style="color:#75715e"># Alternate constructor</span>
    <span style="color:#a6e22e">@classmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">today</span>(cls):
        t <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>localtime()
        <span style="color:#66d9ef">return</span> cls(t<span style="color:#f92672">.</span>tm_year, t<span style="color:#f92672">.</span>tm_mon, t<span style="color:#f92672">.</span>tm_mday)
</code></pre></div><h3 id="init">创建不调用init方法的实例</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Date</span>:
    <span style="color:#66d9ef">def</span> __init__(self, year, month, day):
        self<span style="color:#f92672">.</span>year <span style="color:#f92672">=</span> year
        self<span style="color:#f92672">.</span>month <span style="color:#f92672">=</span> month
        self<span style="color:#f92672">.</span>day <span style="color:#f92672">=</span> day

d <span style="color:#f92672">=</span> Date<span style="color:#f92672">.</span>__new__(Date)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> data <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">year</span><span style="color:#e6db74">&#39;</span>:<span style="color:#ae81ff">2012</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">month</span><span style="color:#e6db74">&#39;</span>:<span style="color:#ae81ff">8</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">day</span><span style="color:#e6db74">&#39;</span>:<span style="color:#ae81ff">29</span>}
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> data<span style="color:#f92672">.</span>items():
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     setattr(d, key, value)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
</code></pre></div><h3 id="heading-24">有用的方法扩展其他类的功能</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">LoggedMapping</span>(cls):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">第二种方式：使用类装饰器</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    cls_getitem <span style="color:#f92672">=</span> cls<span style="color:#f92672">.</span>__getitem__
    cls_setitem <span style="color:#f92672">=</span> cls<span style="color:#f92672">.</span>__setitem__
    cls_delitem <span style="color:#f92672">=</span> cls<span style="color:#f92672">.</span>__delitem__

    <span style="color:#66d9ef">def</span> __getitem__(self, key):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Getting </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(key))
        <span style="color:#66d9ef">return</span> cls_getitem(self, key)

    <span style="color:#66d9ef">def</span> __setitem__(self, key, value):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Setting {} = {!r}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(key, value))
        <span style="color:#66d9ef">return</span> cls_setitem(self, key, value)

    <span style="color:#66d9ef">def</span> __delitem__(self, key):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Deleting </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(key))
        <span style="color:#66d9ef">return</span> cls_delitem(self, key)

    cls<span style="color:#f92672">.</span>__getitem__ <span style="color:#f92672">=</span> __getitem__
    cls<span style="color:#f92672">.</span>__setitem__ <span style="color:#f92672">=</span> __setitem__
    cls<span style="color:#f92672">.</span>__delitem__ <span style="color:#f92672">=</span> __delitem__
    <span style="color:#66d9ef">return</span> cls


<span style="color:#a6e22e">@LoggedMapping</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LoggedDict</span>(dict):
    <span style="color:#66d9ef">pass</span>
</code></pre></div><h3 id="heading-25">实现状态对象或者状态机</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Connection</span>:
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">新方案——对每个状态定义一个类</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>new_state(ClosedConnectionState)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">new_state</span>(self, newstate):
        self<span style="color:#f92672">.</span>_state <span style="color:#f92672">=</span> newstate
        <span style="color:#75715e"># Delegate to the state class</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_state<span style="color:#f92672">.</span>read(self)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write</span>(self, data):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_state<span style="color:#f92672">.</span>write(self, data)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">open</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_state<span style="color:#f92672">.</span>open(self)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_state<span style="color:#f92672">.</span>close(self)


<span style="color:#75715e"># Connection state base class</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConnectionState</span>:
    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>(conn):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>()

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write</span>(conn, data):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>()

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">open</span>(conn):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>()

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close</span>(conn):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">NotImplementedError</span>()


<span style="color:#75715e"># Implementation of different states</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClosedConnectionState</span>(ConnectionState):
    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>(conn):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Not open</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write</span>(conn, data):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Not open</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">open</span>(conn):
        conn<span style="color:#f92672">.</span>new_state(OpenConnectionState)

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close</span>(conn):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Already closed</span><span style="color:#e6db74">&#39;</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OpenConnectionState</span>(ConnectionState):
    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read</span>(conn):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">reading</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write</span>(conn, data):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">writing</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">open</span>(conn):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Already open</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close</span>(conn):
        conn<span style="color:#f92672">.</span>new_state(ClosedConnectionState)
        
c <span style="color:#f92672">=</span> Connection()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>_state
<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">__main__</span><span style="color:#f92672">.</span>ClosedConnectionState<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&gt;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>open()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>_state
<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">__main__</span><span style="color:#f92672">.</span>OpenConnectionState<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&gt;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>read()
reading
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>write(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">hello</span><span style="color:#e6db74">&#39;</span>)
writing
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>close()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>_state
<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">__main__</span><span style="color:#f92672">.</span>ClosedConnectionState<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&gt;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="heading-26">通过字符串调用对象方法</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> math

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Point</span>:
    <span style="color:#66d9ef">def</span> __init__(self, x, y):
        self<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> x
        self<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> y

    <span style="color:#66d9ef">def</span> __repr__(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Point({!r:},{!r:})</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>x, self<span style="color:#f92672">.</span>y)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">distance</span>(self, x, y):
        <span style="color:#66d9ef">return</span> math<span style="color:#f92672">.</span>hypot(self<span style="color:#f92672">.</span>x <span style="color:#f92672">-</span> x, self<span style="color:#f92672">.</span>y <span style="color:#f92672">-</span> y)


p <span style="color:#f92672">=</span> Point(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>)
d <span style="color:#f92672">=</span> getattr(p, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">distance</span><span style="color:#e6db74">&#39;</span>)(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># Calls p.distance(0, 0)</span>

<span style="color:#f92672">import</span> operator
operator<span style="color:#f92672">.</span>methodcaller(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">distance</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)(p)
</code></pre></div><h3 id="heading-27">实现访问者模式(递归实现法)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Node</span>:
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnaryOperator</span>(Node):
    <span style="color:#66d9ef">def</span> __init__(self, operand):
        self<span style="color:#f92672">.</span>operand <span style="color:#f92672">=</span> operand

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BinaryOperator</span>(Node):
    <span style="color:#66d9ef">def</span> __init__(self, left, right):
        self<span style="color:#f92672">.</span>left <span style="color:#f92672">=</span> left
        self<span style="color:#f92672">.</span>right <span style="color:#f92672">=</span> right

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Add</span>(BinaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sub</span>(BinaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Mul</span>(BinaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Div</span>(BinaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Negate</span>(UnaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Number</span>(Node):
    <span style="color:#66d9ef">def</span> __init__(self, value):
        self<span style="color:#f92672">.</span>value <span style="color:#f92672">=</span> value

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NodeVisitor</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit</span>(self, node):
        methname <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">visit_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> type(node)<span style="color:#f92672">.</span>__name__
        meth <span style="color:#f92672">=</span> getattr(self, methname, None)
        <span style="color:#66d9ef">if</span> meth <span style="color:#f92672">is</span> None:
            meth <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>generic_visit
        <span style="color:#66d9ef">return</span> meth(node)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generic_visit</span>(self, node):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">No {} method</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">visit_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> type(node)<span style="color:#f92672">.</span>__name__))

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Evaluator</span>(NodeVisitor):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Number</span>(self, node):
        <span style="color:#66d9ef">return</span> node<span style="color:#f92672">.</span>value

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Add</span>(self, node):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>visit(node<span style="color:#f92672">.</span>left) <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>visit(node<span style="color:#f92672">.</span>right)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Sub</span>(self, node):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>visit(node<span style="color:#f92672">.</span>left) <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>visit(node<span style="color:#f92672">.</span>right)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Mul</span>(self, node):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>visit(node<span style="color:#f92672">.</span>left) <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>visit(node<span style="color:#f92672">.</span>right)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Div</span>(self, node):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>visit(node<span style="color:#f92672">.</span>left) <span style="color:#f92672">/</span> self<span style="color:#f92672">.</span>visit(node<span style="color:#f92672">.</span>right)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Negate</span>(self, node):
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>node<span style="color:#f92672">.</span>operand
      
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> e <span style="color:#f92672">=</span> Evaluator()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> e<span style="color:#f92672">.</span>visit(t4)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HTTPHandler</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle</span>(self, request):
        methname <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">do_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> request<span style="color:#f92672">.</span>request_method
        getattr(self, methname)(request)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_GET</span>(self, request):
        <span style="color:#66d9ef">pass</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_POST</span>(self, request):
        <span style="color:#66d9ef">pass</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_HEAD</span>(self, request):
        <span style="color:#66d9ef">pass</span>
</code></pre></div><h3 id="heading-28">实现访问者模式(非递归实现法)</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> types

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Node</span>:
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NodeVisitor</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit</span>(self, node):
        stack <span style="color:#f92672">=</span> [node]
        last_result <span style="color:#f92672">=</span> None
        <span style="color:#66d9ef">while</span> stack:
            <span style="color:#66d9ef">try</span>:
                last <span style="color:#f92672">=</span> stack[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
                <span style="color:#66d9ef">if</span> isinstance(last, types<span style="color:#f92672">.</span>GeneratorType):
                    stack<span style="color:#f92672">.</span>append(last<span style="color:#f92672">.</span>send(last_result))
                    last_result <span style="color:#f92672">=</span> None
                <span style="color:#66d9ef">elif</span> isinstance(last, Node):
                    stack<span style="color:#f92672">.</span>append(self<span style="color:#f92672">.</span>_visit(stack<span style="color:#f92672">.</span>pop()))
                <span style="color:#66d9ef">else</span>:
                    last_result <span style="color:#f92672">=</span> stack<span style="color:#f92672">.</span>pop()
            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">StopIteration</span>:
                stack<span style="color:#f92672">.</span>pop()

        <span style="color:#66d9ef">return</span> last_result

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_visit</span>(self, node):
        methname <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">visit_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> type(node)<span style="color:#f92672">.</span>__name__
        meth <span style="color:#f92672">=</span> getattr(self, methname, None)
        <span style="color:#66d9ef">if</span> meth <span style="color:#f92672">is</span> None:
            meth <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>generic_visit
        <span style="color:#66d9ef">return</span> meth(node)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generic_visit</span>(self, node):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">No {} method</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">visit_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> type(node)<span style="color:#f92672">.</span>__name__))
        
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnaryOperator</span>(Node):
    <span style="color:#66d9ef">def</span> __init__(self, operand):
        self<span style="color:#f92672">.</span>operand <span style="color:#f92672">=</span> operand

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BinaryOperator</span>(Node):
    <span style="color:#66d9ef">def</span> __init__(self, left, right):
        self<span style="color:#f92672">.</span>left <span style="color:#f92672">=</span> left
        self<span style="color:#f92672">.</span>right <span style="color:#f92672">=</span> right

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Add</span>(BinaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sub</span>(BinaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Mul</span>(BinaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Div</span>(BinaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Negate</span>(UnaryOperator):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Number</span>(Node):
    <span style="color:#66d9ef">def</span> __init__(self, value):
        self<span style="color:#f92672">.</span>value <span style="color:#f92672">=</span> value

<span style="color:#75715e"># A sample visitor class that evaluates expressions</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Evaluator</span>(NodeVisitor):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Number</span>(self, node):
        <span style="color:#66d9ef">return</span> node<span style="color:#f92672">.</span>value

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Add</span>(self, node):
        <span style="color:#66d9ef">yield</span> (<span style="color:#66d9ef">yield</span> node<span style="color:#f92672">.</span>left) <span style="color:#f92672">+</span> (<span style="color:#66d9ef">yield</span> node<span style="color:#f92672">.</span>right)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Sub</span>(self, node):
        <span style="color:#66d9ef">yield</span> (<span style="color:#66d9ef">yield</span> node<span style="color:#f92672">.</span>left) <span style="color:#f92672">-</span> (<span style="color:#66d9ef">yield</span> node<span style="color:#f92672">.</span>right)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Mul</span>(self, node):
        <span style="color:#66d9ef">yield</span> (<span style="color:#66d9ef">yield</span> node<span style="color:#f92672">.</span>left) <span style="color:#f92672">*</span> (<span style="color:#66d9ef">yield</span> node<span style="color:#f92672">.</span>right)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Div</span>(self, node):
        <span style="color:#66d9ef">yield</span> (<span style="color:#66d9ef">yield</span> node<span style="color:#f92672">.</span>left) <span style="color:#f92672">/</span> (<span style="color:#66d9ef">yield</span> node<span style="color:#f92672">.</span>right)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visit_Negate</span>(self, node):
        <span style="color:#66d9ef">yield</span> <span style="color:#f92672">-</span> (<span style="color:#66d9ef">yield</span> node<span style="color:#f92672">.</span>operand)
        
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> a <span style="color:#f92672">=</span> Number(<span style="color:#ae81ff">0</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">100000</span>):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     a <span style="color:#f92672">=</span> Add(a, Number(n))
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> e <span style="color:#f92672">=</span> Evaluator()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> e<span style="color:#f92672">.</span>visit(a)
<span style="color:#ae81ff">4999950000</span>
</code></pre></div><h3 id="heading-29">循环引用数据结构的内存管理</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> weakref

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Node</span>:
    <span style="color:#66d9ef">def</span> __init__(self, value):
        self<span style="color:#f92672">.</span>value <span style="color:#f92672">=</span> value
        self<span style="color:#f92672">.</span>_parent <span style="color:#f92672">=</span> None
        self<span style="color:#f92672">.</span>children <span style="color:#f92672">=</span> []

    <span style="color:#66d9ef">def</span> __repr__(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Node({!r:})</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>value)

    <span style="color:#75715e"># property that manages the parent as a weak-reference</span>
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parent</span>(self):
        <span style="color:#66d9ef">return</span> None <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_parent <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> self<span style="color:#f92672">.</span>_parent()

    <span style="color:#a6e22e">@parent.setter</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parent</span>(self, node):
        self<span style="color:#f92672">.</span>_parent <span style="color:#f92672">=</span> weakref<span style="color:#f92672">.</span>ref(node)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_child</span>(self, child):
        self<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>append(child)
        child<span style="color:#f92672">.</span>parent <span style="color:#f92672">=</span> self
        
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> root <span style="color:#f92672">=</span> Node(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">parent</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c1 <span style="color:#f92672">=</span> Node(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">child</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> root<span style="color:#f92672">.</span>add_child(c1)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">print</span>(c1<span style="color:#f92672">.</span>parent)
Node(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">parent</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">del</span> root
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">print</span>(c1<span style="color:#f92672">.</span>parent)
None
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="heading-30">让类支持比较操作</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> total_ordering

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Room</span>:
    <span style="color:#66d9ef">def</span> __init__(self, name, length, width):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>length <span style="color:#f92672">=</span> length
        self<span style="color:#f92672">.</span>width <span style="color:#f92672">=</span> width
        self<span style="color:#f92672">.</span>square_feet <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>length <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>width

<span style="color:#a6e22e">@total_ordering</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">House</span>:
    <span style="color:#66d9ef">def</span> __init__(self, name, style):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>style <span style="color:#f92672">=</span> style
        self<span style="color:#f92672">.</span>rooms <span style="color:#f92672">=</span> list()

    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">living_space_footage</span>(self):
        <span style="color:#66d9ef">return</span> sum(r<span style="color:#f92672">.</span>square_feet <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>rooms)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_room</span>(self, room):
        self<span style="color:#f92672">.</span>rooms<span style="color:#f92672">.</span>append(room)

    <span style="color:#66d9ef">def</span> __str__(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}: {} square foot {}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>name,
                self<span style="color:#f92672">.</span>living_space_footage,
                self<span style="color:#f92672">.</span>style)

    <span style="color:#66d9ef">def</span> __eq__(self, other):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>living_space_footage <span style="color:#f92672">==</span> other<span style="color:#f92672">.</span>living_space_footage

    <span style="color:#66d9ef">def</span> __lt__(self, other):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>living_space_footage <span style="color:#f92672">&lt;</span> other<span style="color:#f92672">.</span>living_space_footage
</code></pre></div><h3 id="heading-31">创建缓存实例</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CachedSpamManager</span>:
    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>_cache <span style="color:#f92672">=</span> weakref<span style="color:#f92672">.</span>WeakValueDictionary()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_spam</span>(self, name):
        <span style="color:#66d9ef">if</span> name <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_cache:
            temp <span style="color:#f92672">=</span> Spam<span style="color:#f92672">.</span>_new(name)  <span style="color:#75715e"># Modified creation</span>
            self<span style="color:#f92672">.</span>_cache[name] <span style="color:#f92672">=</span> temp
        <span style="color:#66d9ef">else</span>:
            temp <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_cache[name]
        <span style="color:#66d9ef">return</span> temp

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clear</span>(self):
            self<span style="color:#f92672">.</span>_cache<span style="color:#f92672">.</span>clear()

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Spam</span>:
    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">t instantiate directly</span><span style="color:#e6db74">&#34;</span>)

    <span style="color:#75715e"># Alternate constructor</span>
    <span style="color:#a6e22e">@classmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_new</span>(cls, name):
        self <span style="color:#f92672">=</span> cls<span style="color:#f92672">.</span>__new__(cls)
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        <span style="color:#66d9ef">return</span> self
</code></pre></div><h2 id="heading-32">元编程</h2>
<h3 id="heading-33">在函数上添加包装器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> time
<span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">timethis</span>(func):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    Decorator that reports the execution time.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#39;&#39;&#39;</span>
    <span style="color:#a6e22e">@wraps</span>(func)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        start <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
        result <span style="color:#f92672">=</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
        end <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
        <span style="color:#66d9ef">print</span>(func<span style="color:#f92672">.</span>__name__, end<span style="color:#f92672">-</span>start)
        <span style="color:#66d9ef">return</span> result
    <span style="color:#66d9ef">return</span> wrapper
  
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">@timethis</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">countdown</span>(n):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">...     Counts down</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">...     </span><span style="color:#e6db74">&#39;&#39;&#39;</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">while</span> n <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>         n <span style="color:#f92672">-</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span> countdown(<span style="color:#ae81ff">100000</span>)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span> countdown<span style="color:#f92672">.</span>__wrapped__(<span style="color:#ae81ff">100000</span>)
</code></pre></div><h3 id="heading-34">带可选参数的装饰器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps, partial
<span style="color:#f92672">import</span> logging

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logged</span>(func<span style="color:#f92672">=</span>None, <span style="color:#f92672">*</span>, level<span style="color:#f92672">=</span>logging<span style="color:#f92672">.</span>DEBUG, name<span style="color:#f92672">=</span>None, message<span style="color:#f92672">=</span>None):
    <span style="color:#66d9ef">if</span> func <span style="color:#f92672">is</span> None:
        <span style="color:#66d9ef">return</span> partial(logged, level<span style="color:#f92672">=</span>level, name<span style="color:#f92672">=</span>name, message<span style="color:#f92672">=</span>message)

    logname <span style="color:#f92672">=</span> name <span style="color:#66d9ef">if</span> name <span style="color:#66d9ef">else</span> func<span style="color:#f92672">.</span>__module__
    log <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(logname)
    logmsg <span style="color:#f92672">=</span> message <span style="color:#66d9ef">if</span> message <span style="color:#66d9ef">else</span> func<span style="color:#f92672">.</span>__name__

    <span style="color:#a6e22e">@wraps</span>(func)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        log<span style="color:#f92672">.</span>log(level, logmsg)
        <span style="color:#66d9ef">return</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)

    <span style="color:#66d9ef">return</span> wrapper

<span style="color:#75715e"># Example use</span>
<span style="color:#a6e22e">@logged</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x, y):
    <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y

<span style="color:#a6e22e">@logged</span>(level<span style="color:#f92672">=</span>logging<span style="color:#f92672">.</span>CRITICAL, name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">example</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>():
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Spam!</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><h3 id="heading-35">利用装饰器强制函数上的类型检查</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> inspect <span style="color:#f92672">import</span> signature
<span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">typeassert</span>(<span style="color:#f92672">*</span>ty_args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>ty_kwargs):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decorate</span>(func):
        <span style="color:#75715e"># If in optimized mode, disable type checking</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> __debug__:
            <span style="color:#66d9ef">return</span> func

        <span style="color:#75715e"># Map function argument names to supplied types</span>
        sig <span style="color:#f92672">=</span> signature(func)
        bound_types <span style="color:#f92672">=</span> sig<span style="color:#f92672">.</span>bind_partial(<span style="color:#f92672">*</span>ty_args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>ty_kwargs)<span style="color:#f92672">.</span>arguments

        <span style="color:#a6e22e">@wraps</span>(func)
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
            bound_values <span style="color:#f92672">=</span> sig<span style="color:#f92672">.</span>bind(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
            <span style="color:#75715e"># Enforce type assertions across supplied arguments</span>
            <span style="color:#66d9ef">for</span> name, value <span style="color:#f92672">in</span> bound_values<span style="color:#f92672">.</span>arguments<span style="color:#f92672">.</span>items():
                <span style="color:#66d9ef">if</span> name <span style="color:#f92672">in</span> bound_types:
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(value, bound_types[name]):
                        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(
                            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Argument {} must be {}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(name, bound_types[name])
                            )
            <span style="color:#66d9ef">return</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
        <span style="color:#66d9ef">return</span> wrapper
    <span style="color:#66d9ef">return</span> decorate
  
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">@typeassert</span>(int, int)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x, y):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y
</code></pre></div><h3 id="heading-36">将装饰器定义为类</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> types
<span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Profiled</span>:
    <span style="color:#66d9ef">def</span> __init__(self, func):
        wraps(func)(self)
        self<span style="color:#f92672">.</span>ncalls <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">def</span> __call__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        self<span style="color:#f92672">.</span>ncalls <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>__wrapped__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)

    <span style="color:#66d9ef">def</span> __get__(self, instance, cls):
        <span style="color:#66d9ef">if</span> instance <span style="color:#f92672">is</span> None:
            <span style="color:#66d9ef">return</span> self
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> types<span style="color:#f92672">.</span>MethodType(self, instance)

<span style="color:#a6e22e">@Profiled</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x, y):
    <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Spam</span>:
    <span style="color:#a6e22e">@Profiled</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bar</span>(self, x):
        <span style="color:#66d9ef">print</span>(self, x)

<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> add(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>)
<span style="color:#ae81ff">5</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> add(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>)
<span style="color:#ae81ff">9</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> add<span style="color:#f92672">.</span>ncalls
<span style="color:#ae81ff">2</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">=</span> Spam()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s<span style="color:#f92672">.</span>bar(<span style="color:#ae81ff">1</span>)
<span style="color:#f92672">&lt;</span>__main__<span style="color:#f92672">.</span>Spam object at <span style="color:#ae81ff">0x10069e9d0</span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s<span style="color:#f92672">.</span>bar(<span style="color:#ae81ff">2</span>)
<span style="color:#f92672">&lt;</span>__main__<span style="color:#f92672">.</span>Spam object at <span style="color:#ae81ff">0x10069e9d0</span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s<span style="color:#f92672">.</span>bar(<span style="color:#ae81ff">3</span>)
<span style="color:#f92672">&lt;</span>__main__<span style="color:#f92672">.</span>Spam object at <span style="color:#ae81ff">0x10069e9d0</span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> Spam<span style="color:#f92672">.</span>bar<span style="color:#f92672">.</span>ncalls
<span style="color:#ae81ff">3</span>
</code></pre></div><h3 id="heading-37">装饰器为被包装函数增加参数</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">optional_debug</span>(func):
    <span style="color:#a6e22e">@wraps</span>(func)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, debug<span style="color:#f92672">=</span>False, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        <span style="color:#66d9ef">if</span> debug:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Calling</span><span style="color:#e6db74">&#39;</span>, func<span style="color:#f92672">.</span>__name__)
        <span style="color:#66d9ef">return</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)

    <span style="color:#66d9ef">return</span> wrapper

<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">@optional_debug</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>(a,b,c):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">print</span>(a,b,c)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> spam(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>)
<span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> spam(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>, debug<span style="color:#f92672">=</span>True)
Calling spam
<span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="heading-38">使用装饰器扩充类的功能</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">log_getattribute</span>(cls):
    <span style="color:#75715e"># Get the original implementation</span>
    orig_getattribute <span style="color:#f92672">=</span> cls<span style="color:#f92672">.</span>__getattribute__

    <span style="color:#75715e"># Make a new definition</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">new_getattribute</span>(self, name):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">getting:</span><span style="color:#e6db74">&#39;</span>, name)
        <span style="color:#66d9ef">return</span> orig_getattribute(self, name)

    <span style="color:#75715e"># Attach to the class and return</span>
    cls<span style="color:#f92672">.</span>__getattribute__ <span style="color:#f92672">=</span> new_getattribute
    <span style="color:#66d9ef">return</span> cls

<span style="color:#75715e"># Example use</span>
<span style="color:#a6e22e">@log_getattribute</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>:
    <span style="color:#66d9ef">def</span> __init__(self,x):
        self<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> x
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>(self):
        <span style="color:#66d9ef">pass</span>
      
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> a <span style="color:#f92672">=</span> A(<span style="color:#ae81ff">42</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> a<span style="color:#f92672">.</span>x
getting: x
<span style="color:#ae81ff">42</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> a<span style="color:#f92672">.</span>spam()
getting: spam
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="heading-39">使用元类控制实例的创建</h3>
<p>只允许调用类的静态方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NoInstances</span>(type):
    <span style="color:#66d9ef">def</span> __call__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">t instantiate directly</span><span style="color:#e6db74">&#34;</span>)

<span style="color:#75715e"># Example</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Spam</span>(metaclass<span style="color:#f92672">=</span>NoInstances):
    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">grok</span>(x):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Spam.grok</span><span style="color:#e6db74">&#39;</span>)
        
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> Spam<span style="color:#f92672">.</span>grok(<span style="color:#ae81ff">42</span>)
Spam<span style="color:#f92672">.</span>grok
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">=</span> Spam()
Traceback (most recent call last):
    File <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;stdin&gt;</span><span style="color:#e6db74">&#34;</span>, line <span style="color:#ae81ff">1</span>, <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
    File <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">example1.py</span><span style="color:#e6db74">&#34;</span>, line <span style="color:#ae81ff">7</span>, <span style="color:#f92672">in</span> __call__
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">t instantiate directly</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#a6e22e">TypeError</span>: Can<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">t instantiate directly</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><p>单例模式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singleton</span>(type):
    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        self<span style="color:#f92672">.</span>__instance <span style="color:#f92672">=</span> None
        super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)

    <span style="color:#66d9ef">def</span> __call__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>__instance <span style="color:#f92672">is</span> None:
            self<span style="color:#f92672">.</span>__instance <span style="color:#f92672">=</span> super()<span style="color:#f92672">.</span>__call__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>__instance
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>__instance

<span style="color:#75715e"># Example</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Spam</span>(metaclass<span style="color:#f92672">=</span>Singleton):
    <span style="color:#66d9ef">def</span> __init__(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Creating Spam</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><p>缓存模式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> weakref

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Cached</span>(type):
    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
        self<span style="color:#f92672">.</span>__cache <span style="color:#f92672">=</span> weakref<span style="color:#f92672">.</span>WeakValueDictionary()

    <span style="color:#66d9ef">def</span> __call__(self, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">if</span> args <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>__cache:
            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>__cache[args]
        <span style="color:#66d9ef">else</span>:
            obj <span style="color:#f92672">=</span> super()<span style="color:#f92672">.</span>__call__(<span style="color:#f92672">*</span>args)
            self<span style="color:#f92672">.</span>__cache[args] <span style="color:#f92672">=</span> obj
            <span style="color:#66d9ef">return</span> obj

<span style="color:#75715e"># Example</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Spam</span>(metaclass<span style="color:#f92672">=</span>Cached):
    <span style="color:#66d9ef">def</span> __init__(self, name):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Creating Spam({!r})</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(name))
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name

</code></pre></div><p>不过想了下，上面的一些实现还是有并发冲突问题，搜索到<a href="http://dasheyuan.com/post/openstack-singleton-pattern/">openstack中有一处单例模式的写法</a>，感觉这个写法更正确。</p>
<h3 id="heading-40">捕获类的属性定义顺序</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> OrderedDict

<span style="color:#75715e"># A set of descriptors for various types</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Typed</span>:
    _expected_type <span style="color:#f92672">=</span> type(None)
    <span style="color:#66d9ef">def</span> __init__(self, name<span style="color:#f92672">=</span>None):
        self<span style="color:#f92672">.</span>_name <span style="color:#f92672">=</span> name

    <span style="color:#66d9ef">def</span> __set__(self, instance, value):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(value, self<span style="color:#f92672">.</span>_expected_type):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Expected </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> str(self<span style="color:#f92672">.</span>_expected_type))
        instance<span style="color:#f92672">.</span>__dict__[self<span style="color:#f92672">.</span>_name] <span style="color:#f92672">=</span> value

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Integer</span>(Typed):
    _expected_type <span style="color:#f92672">=</span> int

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Float</span>(Typed):
    _expected_type <span style="color:#f92672">=</span> float

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">String</span>(Typed):
    _expected_type <span style="color:#f92672">=</span> str

<span style="color:#75715e"># Metaclass that uses an OrderedDict for class body</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderedMeta</span>(type):
    <span style="color:#66d9ef">def</span> __new__(cls, clsname, bases, clsdict):
        d <span style="color:#f92672">=</span> dict(clsdict)
        order <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> name, value <span style="color:#f92672">in</span> clsdict<span style="color:#f92672">.</span>items():
            <span style="color:#66d9ef">if</span> isinstance(value, Typed):
                value<span style="color:#f92672">.</span>_name <span style="color:#f92672">=</span> name
                order<span style="color:#f92672">.</span>append(name)
        d[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_order</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> order
        <span style="color:#66d9ef">return</span> type<span style="color:#f92672">.</span>__new__(cls, clsname, bases, d)

    <span style="color:#a6e22e">@classmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__prepare__</span>(cls, clsname, bases):
        <span style="color:#66d9ef">return</span> OrderedDict()
      
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Structure</span>(metaclass<span style="color:#f92672">=</span>OrderedMeta):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">as_csv</span>(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">,</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(str(getattr(self,name)) <span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_order)

<span style="color:#75715e"># Example use</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stock</span>(Structure):
    name <span style="color:#f92672">=</span> String()
    shares <span style="color:#f92672">=</span> Integer()
    price <span style="color:#f92672">=</span> Float()

    <span style="color:#66d9ef">def</span> __init__(self, name, shares, price):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>shares <span style="color:#f92672">=</span> shares
        self<span style="color:#f92672">.</span>price <span style="color:#f92672">=</span> price
        
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">=</span> Stock(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">GOOG</span><span style="color:#e6db74">&#39;</span>,<span style="color:#ae81ff">100</span>,<span style="color:#ae81ff">490.1</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s<span style="color:#f92672">.</span>name
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">GOOG</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s<span style="color:#f92672">.</span>as_csv()
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">GOOG,100,490.1</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> t <span style="color:#f92672">=</span> Stock(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AAPL</span><span style="color:#e6db74">&#39;</span>,<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">a lot</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">610.23</span>)
Traceback (most recent call last):
    File <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;stdin&gt;</span><span style="color:#e6db74">&#34;</span>, line <span style="color:#ae81ff">1</span>, <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
    File <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dupmethod.py</span><span style="color:#e6db74">&#34;</span>, line <span style="color:#ae81ff">34</span>, <span style="color:#f92672">in</span> __init__
<span style="color:#a6e22e">TypeError</span>: shares expects <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">int</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&gt;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="heading-41">定义有可选参数的元类</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyMeta</span>(type):
    <span style="color:#75715e"># Optional</span>
    <span style="color:#a6e22e">@classmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__prepare__</span>(cls, name, bases, <span style="color:#f92672">*</span>, debug<span style="color:#f92672">=</span>False, synchronize<span style="color:#f92672">=</span>False):
        <span style="color:#75715e"># Custom processing</span>
        <span style="color:#66d9ef">pass</span>
        <span style="color:#66d9ef">return</span> super()<span style="color:#f92672">.</span>__prepare__(name, bases)

    <span style="color:#75715e"># Required</span>
    <span style="color:#66d9ef">def</span> __new__(cls, name, bases, ns, <span style="color:#f92672">*</span>, debug<span style="color:#f92672">=</span>False, synchronize<span style="color:#f92672">=</span>False):
        <span style="color:#75715e"># Custom processing</span>
        <span style="color:#66d9ef">pass</span>
        <span style="color:#66d9ef">return</span> super()<span style="color:#f92672">.</span>__new__(cls, name, bases, ns)

    <span style="color:#75715e"># Required</span>
    <span style="color:#66d9ef">def</span> __init__(self, name, bases, ns, <span style="color:#f92672">*</span>, debug<span style="color:#f92672">=</span>False, synchronize<span style="color:#f92672">=</span>False):
        <span style="color:#75715e"># Custom processing</span>
        <span style="color:#66d9ef">pass</span>
        super()<span style="color:#f92672">.</span>__init__(name, bases, ns)
        
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Spam</span>(metaclass<span style="color:#f92672">=</span>MyMeta, debug<span style="color:#f92672">=</span>True, synchronize<span style="color:#f92672">=</span>True):
    <span style="color:#66d9ef">pass</span>
</code></pre></div><h3 id="argskwargs">args和kwargs的强制参数签名</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> inspect <span style="color:#f92672">import</span> Signature, Parameter

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_sig</span>(<span style="color:#f92672">*</span>names):
    parms <span style="color:#f92672">=</span> [Parameter(name, Parameter<span style="color:#f92672">.</span>POSITIONAL_OR_KEYWORD)
            <span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> names]
    <span style="color:#66d9ef">return</span> Signature(parms)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StructureMeta</span>(type):
    <span style="color:#66d9ef">def</span> __new__(cls, clsname, bases, clsdict):
        clsdict[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__signature__</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> make_sig(<span style="color:#f92672">*</span>clsdict<span style="color:#f92672">.</span>get(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_fields</span><span style="color:#e6db74">&#39;</span>,[]))
        <span style="color:#66d9ef">return</span> super()<span style="color:#f92672">.</span>__new__(cls, clsname, bases, clsdict)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Structure</span>(metaclass<span style="color:#f92672">=</span>StructureMeta):
    _fields <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        bound_values <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>__signature__<span style="color:#f92672">.</span>bind(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
        <span style="color:#66d9ef">for</span> name, value <span style="color:#f92672">in</span> bound_values<span style="color:#f92672">.</span>arguments<span style="color:#f92672">.</span>items():
            setattr(self, name, value)

<span style="color:#75715e"># Example</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stock</span>(Structure):
    _fields <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">shares</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">price</span><span style="color:#e6db74">&#39;</span>]

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Point</span>(Structure):
    _fields <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">x</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">y</span><span style="color:#e6db74">&#39;</span>]
</code></pre></div><h3 id="heading-42">在类上强制使用编程规约</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> inspect <span style="color:#f92672">import</span> signature
<span style="color:#f92672">import</span> logging

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MatchSignaturesMeta</span>(type):

    <span style="color:#66d9ef">def</span> __init__(self, clsname, bases, clsdict):
        super()<span style="color:#f92672">.</span>__init__(clsname, bases, clsdict)
        sup <span style="color:#f92672">=</span> super(self, self)
        <span style="color:#66d9ef">for</span> name, value <span style="color:#f92672">in</span> clsdict<span style="color:#f92672">.</span>items():
            <span style="color:#66d9ef">if</span> name<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span>) <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> callable(value):
                <span style="color:#66d9ef">continue</span>
            <span style="color:#75715e"># Get the previous definition (if any) and compare the signatures</span>
            prev_dfn <span style="color:#f92672">=</span> getattr(sup,name,None)
            <span style="color:#66d9ef">if</span> prev_dfn:
                prev_sig <span style="color:#f92672">=</span> signature(prev_dfn)
                val_sig <span style="color:#f92672">=</span> signature(value)
                <span style="color:#66d9ef">if</span> prev_sig <span style="color:#f92672">!=</span> val_sig:
                    logging<span style="color:#f92672">.</span>warning(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Signature mismatch in </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">. </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> != </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span>,
                                    value<span style="color:#f92672">.</span>__qualname__, prev_sig, val_sig)

<span style="color:#75715e"># Example</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Root</span>(metaclass<span style="color:#f92672">=</span>MatchSignaturesMeta):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>(Root):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(self, x, y):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>(self, x, <span style="color:#f92672">*</span>, z):
        <span style="color:#66d9ef">pass</span>

<span style="color:#75715e"># Class with redefined methods, but slightly different signatures</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span>(A):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(self, a, b):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>(self,x,z):
        <span style="color:#66d9ef">pass</span>
</code></pre></div><h3 id="heading-43">以编程方式定义类</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> operator
<span style="color:#f92672">import</span> types
<span style="color:#f92672">import</span> sys

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">named_tuple</span>(classname, fieldnames):
    <span style="color:#75715e"># Populate a dictionary of field property accessors</span>
    cls_dict <span style="color:#f92672">=</span> { name: property(operator<span style="color:#f92672">.</span>itemgetter(n))
                <span style="color:#66d9ef">for</span> n, name <span style="color:#f92672">in</span> enumerate(fieldnames) }

    <span style="color:#75715e"># Make a __new__ function and add to the class dict</span>
    <span style="color:#66d9ef">def</span> __new__(cls, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">if</span> len(args) <span style="color:#f92672">!=</span> len(fieldnames):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Expected {} arguments</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(len(fieldnames)))
        <span style="color:#66d9ef">return</span> tuple<span style="color:#f92672">.</span>__new__(cls, args)

    cls_dict[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__new__</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> __new__

    <span style="color:#75715e"># Make the class</span>
    cls <span style="color:#f92672">=</span> types<span style="color:#f92672">.</span>new_class(classname, (tuple,), {},
                        <span style="color:#66d9ef">lambda</span> ns: ns<span style="color:#f92672">.</span>update(cls_dict))

    <span style="color:#75715e"># Set the module to that of the caller</span>
    cls<span style="color:#f92672">.</span>__module__ <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>_getframe(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>f_globals[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__name__</span><span style="color:#e6db74">&#39;</span>]
    <span style="color:#66d9ef">return</span> cls
</code></pre></div><p><code>types.new_class</code>的详细用法参考<a href="https://docs.python.org/3/library/types.html">https://docs.python.org/3/library/types.html</a></p>
<h3 id="heading-44">在定义的时候初始化类的成员</h3>
<p>在类定义时就执行初始化或设置操作是元类的一个典型应用场景。本质上讲，一个元类会在定义时被触发， 这时候你可以执行一些额外的操作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> operator

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StructTupleMeta</span>(type):
    <span style="color:#66d9ef">def</span> __init__(cls, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
        <span style="color:#66d9ef">for</span> n, name <span style="color:#f92672">in</span> enumerate(cls<span style="color:#f92672">.</span>_fields):
            setattr(cls, name, property(operator<span style="color:#f92672">.</span>itemgetter(n)))

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StructTuple</span>(tuple, metaclass<span style="color:#f92672">=</span>StructTupleMeta):
    _fields <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">def</span> __new__(cls, <span style="color:#f92672">*</span>args):
        <span style="color:#66d9ef">if</span> len(args) <span style="color:#f92672">!=</span> len(cls<span style="color:#f92672">.</span>_fields):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{} arguments required</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(len(cls<span style="color:#f92672">.</span>_fields)))
        <span style="color:#66d9ef">return</span> super()<span style="color:#f92672">.</span>__new__(cls,args)
      
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stock</span>(StructTuple):
    _fields <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">shares</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">price</span><span style="color:#e6db74">&#39;</span>]

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Point</span>(StructTuple):
    _fields <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">x</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">y</span><span style="color:#e6db74">&#39;</span>]
    
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">=</span> Stock(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ACME</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">91.1</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s
(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ACME</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">91.1</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s[<span style="color:#ae81ff">0</span>]
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ACME</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s<span style="color:#f92672">.</span>name
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ACME</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s<span style="color:#f92672">.</span>shares <span style="color:#f92672">*</span> s<span style="color:#f92672">.</span>price
<span style="color:#ae81ff">4555.0</span>
</code></pre></div><h3 id="heading-45">避免重复的属性方法</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">typed_property</span>(name, expected_type):
    storage_name <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">_</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> name

    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">prop</span>(self):
        <span style="color:#66d9ef">return</span> getattr(self, storage_name)

    <span style="color:#a6e22e">@prop.setter</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">prop</span>(self, value):
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(value, expected_type):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{} must be a {}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(name, expected_type))
        setattr(self, storage_name, value)

    <span style="color:#66d9ef">return</span> prop
  
<span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> partial

String <span style="color:#f92672">=</span> partial(typed_property, expected_type<span style="color:#f92672">=</span>str)
Integer <span style="color:#f92672">=</span> partial(typed_property, expected_type<span style="color:#f92672">=</span>int)

<span style="color:#75715e"># Example:</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Person</span>:
    name <span style="color:#f92672">=</span> String(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name</span><span style="color:#e6db74">&#39;</span>)
    age <span style="color:#f92672">=</span> Integer(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">age</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#66d9ef">def</span> __init__(self, name, age):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>age <span style="color:#f92672">=</span> age
        

</code></pre></div><h3 id="heading-46">定义上下文管理器的简单方法</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> time
<span style="color:#f92672">from</span> contextlib <span style="color:#f92672">import</span> contextmanager

<span style="color:#a6e22e">@contextmanager</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">timethis</span>(label):
    start <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">yield</span>
    <span style="color:#66d9ef">finally</span>:
        end <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}: {}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(label, end <span style="color:#f92672">-</span> start))

<span style="color:#75715e"># Example use</span>
<span style="color:#66d9ef">with</span> timethis(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">counting</span><span style="color:#e6db74">&#39;</span>):
    n <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000000</span>
    <span style="color:#66d9ef">while</span> n <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
        n <span style="color:#f92672">-</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        

<span style="color:#75715e"># 这段代码的作用是任何对列表的修改只有当所有代码运行完成并且不出现异常的情况下才会生效。 </span>
<span style="color:#a6e22e">@contextmanager</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_transaction</span>(orig_list):
    working <span style="color:#f92672">=</span> list(orig_list)
    <span style="color:#66d9ef">yield</span> working
    orig_list[:] <span style="color:#f92672">=</span> working
    
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> items <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">with</span> list_transaction(items) <span style="color:#66d9ef">as</span> working:
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     working<span style="color:#f92672">.</span>append(<span style="color:#ae81ff">4</span>)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     working<span style="color:#f92672">.</span>append(<span style="color:#ae81ff">5</span>)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> items
[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">with</span> list_transaction(items) <span style="color:#66d9ef">as</span> working:
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     working<span style="color:#f92672">.</span>append(<span style="color:#ae81ff">6</span>)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     working<span style="color:#f92672">.</span>append(<span style="color:#ae81ff">7</span>)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">oops</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
Traceback (most recent call last):
    File <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;stdin&gt;</span><span style="color:#e6db74">&#34;</span>, line <span style="color:#ae81ff">4</span>, <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
<span style="color:#a6e22e">RuntimeError</span>: oops
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> items
[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="heading-47">在局部变量域中执行代码</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test4</span>():
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     a <span style="color:#f92672">=</span> <span style="color:#ae81ff">13</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     loc <span style="color:#f92672">=</span> { <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">a</span><span style="color:#e6db74">&#39;</span> : a }
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     glb <span style="color:#f92672">=</span> { }
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">exec</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">b = a + 1</span><span style="color:#e6db74">&#39;</span>, glb, loc)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     b <span style="color:#f92672">=</span> loc[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span>]
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">print</span>(b)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> test4()
<span style="color:#ae81ff">14</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h2 id="heading-48">模块与包</h2>
<h3 id="heading-49">控制模块被全部导入的内容</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># somemodule.py</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>():
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">grok</span>():
    <span style="color:#66d9ef">pass</span>

blah <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>
<span style="color:#75715e"># Only export &#39;spam&#39; and &#39;grok&#39;</span>
__all__ <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">spam</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">grok</span><span style="color:#e6db74">&#39;</span>]
</code></pre></div><h3 id="heading-50">使用相对路径名导入包中子模块</h3>
<pre><code>mypackage/
    __init__.py
    A/
        __init__.py
        spam.py
        grok.py
    B/
        __init__.py
        bar.py
</code></pre><p>如果模块mypackage.A.spam要导入同目录下的模块grok，它应该包括的import语句如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># mypackage/A/spam.py</span>
<span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> grok
</code></pre></div><p>如果模块mypackage.A.spam要导入不同目录下的模块B.bar，它应该使用的import语句如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># mypackage/A/spam.py</span>
<span style="color:#f92672">from</span> ..B <span style="color:#f92672">import</span> bar
</code></pre></div><h3 id="heading-51">将模块分割成多个文件</h3>
<pre><code>mymodule/
    __init__.py
    a.py
    b.py
</code></pre><p>在a.py文件中插入以下代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># a.py</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">spam</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">A.spam</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><p>在b.py文件中插入以下代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># b.py</span>
<span style="color:#f92672">from</span> .a <span style="color:#f92672">import</span> A
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span>(A):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bar</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">B.bar</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><p>最后，在 <code>__init__.py</code> 中，将2个文件粘合在一起：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># __init__.py</span>
<span style="color:#f92672">from</span> .a <span style="color:#f92672">import</span> A
<span style="color:#f92672">from</span> .b <span style="color:#f92672">import</span> B
</code></pre></div><p>如果按照这些步骤，所产生的包MyModule将作为一个单一的逻辑模块：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">import</span> mymodule
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> a <span style="color:#f92672">=</span> mymodule<span style="color:#f92672">.</span>A()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> a<span style="color:#f92672">.</span>spam()
A<span style="color:#f92672">.</span>spam
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> b <span style="color:#f92672">=</span> mymodule<span style="color:#f92672">.</span>B()
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> b<span style="color:#f92672">.</span>bar()
B<span style="color:#f92672">.</span>bar
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="heading-52">利用命名空间导入目录分散的代码</h3>
<pre><code>foo-package/
    spam/
        blah.py

bar-package/
    spam/
        grok.py
</code></pre><p>在这2个目录里，都有着共同的命名空间spam。在任何一个目录里都没有<code>__init__.py</code>文件。</p>
<p>如果将foo-package和bar-package都加到python模块路径:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">import</span> sys
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> sys<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>extend([<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">foo-package</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">bar-package</span><span style="color:#e6db74">&#39;</span>])
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">import</span> spam.blah
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">import</span> spam.grok
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><p>两个不同的包目录被合并到一起，你可以导入spam.blah和spam.grok，并且它们能够工作。</p>
<p>在这里工作的机制被称为“包命名空间”的一个特征。从本质上讲，包命名空间是一种特殊的封装设计，为合并不同的目录的代码到一个共同的命名空间。对于大的框架，这可能是有用的，因为它允许一个框架的部分被单独地安装下载。它也使人们能够轻松地为这样的框架编写第三方附加组件和其他扩展。</p>
<p>包命名空间的关键是确保顶级目录中没有<code>__init__.py</code>文件来作为共同的命名空间。缺失<code>__init__.py</code>文件使得在导入包的时候会发生有趣的事情：这并没有产生错误，解释器创建了一个由所有包含匹配包名的目录组成的列表。特殊的包命名空间模块被创建，只读的目录列表副本被存储在其<code>__path__</code>变量中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">import</span> spam
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> spam<span style="color:#f92672">.</span>__path__
_NamespacePath([<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">foo-package/spam</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">bar-package/spam</span><span style="color:#e6db74">&#39;</span>])
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> spam<span style="color:#f92672">.</span>__file__
Traceback (most recent call last):
    File <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;stdin&gt;</span><span style="color:#e6db74">&#34;</span>, line <span style="color:#ae81ff">1</span>, <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
<span style="color:#a6e22e">AttributeError</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">module</span><span style="color:#e6db74">&#39;</span> object has no attribute <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__file__</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> spam
<span style="color:#f92672">&lt;</span>module <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">spam</span><span style="color:#e6db74">&#39;</span> (namespace)<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="heading-53">运行目录或压缩文件</h3>
<pre><code>myapplication/
    spam.py
    bar.py
    grok.py
    __main__.py
</code></pre><p>如果<code>__main__.py</code>存在，你可以简单地在顶级目录运行Python解释器：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash % python3 myapplication
</code></pre></div><p>如果你将你的代码打包成zip文件，这种技术同样也适用，举个例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash % ls
spam.py bar.py grok.py __main__.py
bash % zip -r myapp.zip *.py
bash % python3 myapp.zip
... output from __main__.py ...
</code></pre></div><h3 id="heading-54">读取位于包中的数据文件</h3>
<pre><code>mypackage/
    __init__.py
    somedata.dat
    spam.py
</code></pre><p>现在假设spam.py文件需要读取somedata.dat文件中的内容。你可以用以下代码来完成：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># spam.py</span>
<span style="color:#f92672">import</span> pkgutil
data <span style="color:#f92672">=</span> pkgutil<span style="color:#f92672">.</span>get_data(__package__, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">somedata.dat</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><p>由此产生的变量是包含该文件的原始内容的字节字符串。</p>
<h3 id="syspath">将文件夹加入到sys.path</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> sys
<span style="color:#f92672">from</span> os.path <span style="color:#f92672">import</span> abspath, join, dirname
sys<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>, join(abspath(dirname(__file__)), <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">libs</span><span style="color:#e6db74">&#39;</span>))
</code></pre></div><h3 id="heading-55">通过字符串名导入模块</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">import</span> importlib
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> math <span style="color:#f92672">=</span> importlib<span style="color:#f92672">.</span>import_module(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">math</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> math<span style="color:#f92672">.</span>sin(<span style="color:#ae81ff">2</span>)
<span style="color:#ae81ff">0.9092974268256817</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> mod <span style="color:#f92672">=</span> importlib<span style="color:#f92672">.</span>import_module(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">urllib.request</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> u <span style="color:#f92672">=</span> mod<span style="color:#f92672">.</span>urlopen(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://www.python.org</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>

<span style="color:#f92672">import</span> importlib
<span style="color:#75715e"># Same as &#39;from . import b&#39;</span>
b <span style="color:#f92672">=</span> importlib<span style="color:#f92672">.</span>import_module(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">.b</span><span style="color:#e6db74">&#39;</span>, __package__)
</code></pre></div><h3 id="heading-56">安装私有的包</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">python3 setup.py install --user
</code></pre></div><p>或者</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip install --user packagename
</code></pre></div><h3 id="python">创建新的Python环境</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">python3.6 -m venv ./Spam
bash ./Span/bin/activate <span style="color:#75715e">#进入新的python环境</span>
deactivate <span style="color:#75715e">#退出新的python环境</span>
</code></pre></div><h3 id="heading-57">分发包</h3>
<pre><code>projectname/
    README.txt
    Doc/
        documentation.txt
    projectname/
        __init__.py
        foo.py
        bar.py
        utils/
            __init__.py
            spam.py
            grok.py
    examples/
        helloworld.py
        ...
</code></pre><p>要编写一个 <code>setup.py</code> ，类似下面这样：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># setup.py</span>
<span style="color:#f92672">from</span> distutils.core <span style="color:#f92672">import</span> setup

setup(name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">projectname</span><span style="color:#e6db74">&#39;</span>,
    version<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">1.0</span><span style="color:#e6db74">&#39;</span>,
    author<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Your Name</span><span style="color:#e6db74">&#39;</span>,
    author_email<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">you@youraddress.com</span><span style="color:#e6db74">&#39;</span>,
    url<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://www.you.com/projectname</span><span style="color:#e6db74">&#39;</span>,
    packages<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">projectname</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">projectname.utils</span><span style="color:#e6db74">&#39;</span>],
)
</code></pre></div><p>下一步，就是创建一个 <code>MANIFEST.in</code> 文件，列出所有在你的包中需要包含进来的非源码文件：</p>
<pre><code># MANIFEST.in
include *.txt
recursive-include examples *
recursive-include Doc *
</code></pre><p>确保 <code>setup.py</code> 和 <code>MANIFEST.in</code> 文件放在你的包的最顶级目录中。 一旦你已经做了这些，你就可以像下面这样执行命令来创建一个源码分发包了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">% bash python3 setup.py sdist
</code></pre></div><p>它会创建一个文件比如”projectname-1.0.zip” 或 “projectname-1.0.tar.gz”, 具体依赖于你的系统平台。</p>
<h2 id="web">网络与Web编程</h2>
<h3 id="http">作为客户端与HTTP服务交互</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> urllib <span style="color:#f92672">import</span> request, parse


<span style="color:#75715e"># Extra headers</span>
headers <span style="color:#f92672">=</span> {
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">User-agent</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">none/ofyourbusiness</span><span style="color:#e6db74">&#39;</span>,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Spam</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Eggs</span><span style="color:#e6db74">&#39;</span>
}

<span style="color:#75715e"># Base URL being accessed</span>
url <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://httpbin.org/get</span><span style="color:#e6db74">&#39;</span>

<span style="color:#75715e"># Dictionary of query parameters (if any)</span>
parms <span style="color:#f92672">=</span> {
   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name1</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">value1</span><span style="color:#e6db74">&#39;</span>,
   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name2</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">value2</span><span style="color:#e6db74">&#39;</span>
}

<span style="color:#75715e"># Encode the query string</span>
querystring <span style="color:#f92672">=</span> parse<span style="color:#f92672">.</span>urlencode(parms)

<span style="color:#75715e"># Make a GET request and read the response</span>
u <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>urlopen(url<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">?</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> querystring, headers<span style="color:#f92672">=</span>headers)
resp <span style="color:#f92672">=</span> u<span style="color:#f92672">.</span>read()

<span style="color:#f92672">from</span> urllib <span style="color:#f92672">import</span> request, parse

<span style="color:#75715e"># Base URL being accessed</span>
url <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://httpbin.org/post</span><span style="color:#e6db74">&#39;</span>

<span style="color:#75715e"># Dictionary of query parameters (if any)</span>
parms <span style="color:#f92672">=</span> {
   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name1</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">value1</span><span style="color:#e6db74">&#39;</span>,
   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name2</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">value2</span><span style="color:#e6db74">&#39;</span>
}

<span style="color:#75715e"># Encode the query string</span>
querystring <span style="color:#f92672">=</span> parse<span style="color:#f92672">.</span>urlencode(parms)

<span style="color:#75715e"># Make a POST request and read the response</span>
u <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>urlopen(url, querystring<span style="color:#f92672">.</span>encode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ascii</span><span style="color:#e6db74">&#39;</span>), headers<span style="color:#f92672">=</span>headers)
resp <span style="color:#f92672">=</span> u<span style="color:#f92672">.</span>read()
</code></pre></div><p>需要交互的服务比上面的例子都要复杂，也许应该去看看 requests 库（<a href="https://pypi.python.org/pypi/requests">https://pypi.python.org/pypi/requests</a>）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> requests

<span style="color:#75715e"># Base URL being accessed</span>
url <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://httpbin.org/post</span><span style="color:#e6db74">&#39;</span>

<span style="color:#75715e"># Dictionary of query parameters (if any)</span>
parms <span style="color:#f92672">=</span> {
   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name1</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">value1</span><span style="color:#e6db74">&#39;</span>,
   <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name2</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">value2</span><span style="color:#e6db74">&#39;</span>
}

<span style="color:#75715e"># Extra headers</span>
headers <span style="color:#f92672">=</span> {
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">User-agent</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">none/ofyourbusiness</span><span style="color:#e6db74">&#39;</span>,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Spam</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Eggs</span><span style="color:#e6db74">&#39;</span>
}

resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, data<span style="color:#f92672">=</span>parms, headers<span style="color:#f92672">=</span>headers)

<span style="color:#75715e"># Decoded text returned by the request</span>
text <span style="color:#f92672">=</span> resp<span style="color:#f92672">.</span>text
</code></pre></div><h3 id="tcp">创建TCP服务器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> socketserver <span style="color:#f92672">import</span> BaseRequestHandler, TCPServer
<span style="color:#f92672">import</span> traceback

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EchoHandler</span>(BaseRequestHandler):
    <span style="color:#75715e"># Optional settings (defaults shown)</span>
    timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>                      <span style="color:#75715e"># Timeout on all socket operations</span>
    rbufsize <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>                    <span style="color:#75715e"># Read buffer size</span>
    wbufsize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>                     <span style="color:#75715e"># Write buffer size</span>
    disable_nagle_algorithm <span style="color:#f92672">=</span> False  <span style="color:#75715e"># Sets TCP_NODELAY socket option</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Got connection from</span><span style="color:#e6db74">&#39;</span>, self<span style="color:#f92672">.</span>client_address)
        <span style="color:#66d9ef">while</span> True:
            msg <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">8192</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> msg:
                <span style="color:#66d9ef">break</span>
            self<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>send(msg)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EchoTCPServer</span>(TCPServer):

    allow_reuse_address <span style="color:#f92672">=</span> True

    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_serve_forever</span>(self):
        <span style="color:#66d9ef">try</span>:
            self<span style="color:#f92672">.</span>serve_forever()
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
            <span style="color:#66d9ef">pass</span>
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
            traceback<span style="color:#f92672">.</span>print_exc()
        <span style="color:#66d9ef">finally</span>:
            self<span style="color:#f92672">.</span>shutdown()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">serve</span>(self, nworkers<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>):
        <span style="color:#f92672">from</span> concurrent.futures.thread <span style="color:#f92672">import</span> ThreadPoolExecutor
        <span style="color:#66d9ef">with</span> ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span>nworkers, thread_name_prefix<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">echo_tcp_server</span><span style="color:#e6db74">&#39;</span>) <span style="color:#66d9ef">as</span> executor:
            <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(nworkers):
                executor<span style="color:#f92672">.</span>submit(<span style="color:#66d9ef">lambda</span> : self<span style="color:#f92672">.</span>_serve_forever())
            self<span style="color:#f92672">.</span>_serve_forever()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
    serv <span style="color:#f92672">=</span> EchoTCPServer((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">20000</span>), EchoHandler)
    serv<span style="color:#f92672">.</span>serve()
</code></pre></div><h3 id="udp">创建UDP服务器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> socketserver <span style="color:#f92672">import</span> BaseRequestHandler, UDPServer
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> traceback

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TimeHandler</span>(BaseRequestHandler):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Got connection from</span><span style="color:#e6db74">&#39;</span>, self<span style="color:#f92672">.</span>client_address)
        <span style="color:#75715e"># Get message and client socket</span>
        msg, sock <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>request
        resp <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>ctime()
        sock<span style="color:#f92672">.</span>sendto(resp<span style="color:#f92672">.</span>encode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ascii</span><span style="color:#e6db74">&#39;</span>), self<span style="color:#f92672">.</span>client_address)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TimeUDPServer</span>(UDPServer):
    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
        super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_serve_forever</span>(self):
        <span style="color:#66d9ef">try</span>:
            self<span style="color:#f92672">.</span>serve_forever()
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
            <span style="color:#66d9ef">pass</span>
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
            traceback<span style="color:#f92672">.</span>print_exc()
        <span style="color:#66d9ef">finally</span>:
            self<span style="color:#f92672">.</span>shutdown()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">serve</span>(self, nworkers<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>):
        <span style="color:#f92672">from</span> concurrent.futures.thread <span style="color:#f92672">import</span> ThreadPoolExecutor
        <span style="color:#66d9ef">with</span> ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span>nworkers, thread_name_prefix<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">time_udp_server</span><span style="color:#e6db74">&#39;</span>) <span style="color:#66d9ef">as</span> executor:
            <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(nworkers):
                executor<span style="color:#f92672">.</span>submit(<span style="color:#66d9ef">lambda</span> : self<span style="color:#f92672">.</span>_serve_forever())
            self<span style="color:#f92672">.</span>_serve_forever()

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
    serv <span style="color:#f92672">=</span> TimeUDPServer((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">20000</span>), TimeHandler)
    serv<span style="color:#f92672">.</span>serve()
</code></pre></div><h3 id="cidrip">通过CIDR地址生成对应的IP地址集</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">import</span> ipaddress
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> net <span style="color:#f92672">=</span> ipaddress<span style="color:#f92672">.</span>ip_network(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">123.45.67.64/27</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> net
IPv4Network(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">123.45.67.64/27</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> net:
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">print</span>(a)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> net6 <span style="color:#f92672">=</span> ipaddress<span style="color:#f92672">.</span>ip_network(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">12:3456:78:90ab:cd:ef01:23:30/125</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> net6
IPv6Network(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">12:3456:78:90ab:cd:ef01:23:30/125</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> net6:
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>     <span style="color:#66d9ef">print</span>(a)
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> net<span style="color:#f92672">.</span>num_addresses
<span style="color:#ae81ff">32</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> net[<span style="color:#ae81ff">0</span>]

IPv4Address(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">123.45.67.64</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> net[<span style="color:#ae81ff">1</span>]
IPv4Address(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">123.45.67.65</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> net[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
IPv4Address(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">123.45.67.95</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> inet <span style="color:#f92672">=</span> ipaddress<span style="color:#f92672">.</span>ip_interface(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">123.45.67.73/27</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> inet<span style="color:#f92672">.</span>network
IPv4Network(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">123.45.67.64/27</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> inet<span style="color:#f92672">.</span>ip
IPv4Address(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">123.45.67.73</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><h3 id="xml-rpc">通过XML-RPC实现简单的远程调用</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> xmlrpc.server <span style="color:#f92672">import</span> SimpleXMLRPCServer
<span style="color:#f92672">import</span> traceback

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KeyValueServer</span>:
    _rpc_methods_ <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">get</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">set</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">delete</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">exists</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">keys</span><span style="color:#e6db74">&#39;</span>]
    <span style="color:#66d9ef">def</span> __init__(self, address):
        self<span style="color:#f92672">.</span>_data <span style="color:#f92672">=</span> {}
        self<span style="color:#f92672">.</span>_serv <span style="color:#f92672">=</span> SimpleXMLRPCServer(address, allow_none<span style="color:#f92672">=</span>True)
        <span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_rpc_methods_:
            self<span style="color:#f92672">.</span>_serv<span style="color:#f92672">.</span>register_function(getattr(self, name))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, name):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_data[name]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set</span>(self, name, value):
        self<span style="color:#f92672">.</span>_data[name] <span style="color:#f92672">=</span> value

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete</span>(self, name):
        <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>_data[name]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exists</span>(self, name):
        <span style="color:#66d9ef">return</span> name <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_data

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">keys</span>(self):
        <span style="color:#66d9ef">return</span> list(self<span style="color:#f92672">.</span>_data)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">serve_forever</span>(self):
        <span style="color:#66d9ef">try</span>:
            self<span style="color:#f92672">.</span>_serv<span style="color:#f92672">.</span>serve_forever()
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
            <span style="color:#66d9ef">pass</span>
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
            traceback<span style="color:#f92672">.</span>print_exc()
        <span style="color:#66d9ef">finally</span>:
            self<span style="color:#f92672">.</span>_serv<span style="color:#f92672">.</span>shutdown()

<span style="color:#75715e"># Example</span>
<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
    serv <span style="color:#f92672">=</span> KeyValueServer((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">15000</span>))
    nworkers <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">from</span> concurrent.futures.thread <span style="color:#f92672">import</span> ThreadPoolExecutor
    <span style="color:#66d9ef">with</span> ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span>nworkers, thread_name_prefix<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">keyvalue_rcp_server</span><span style="color:#e6db74">&#39;</span>) <span style="color:#66d9ef">as</span> executor:
        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(nworkers):
            executor<span style="color:#f92672">.</span>submit(<span style="color:#66d9ef">lambda</span> : serv<span style="color:#f92672">.</span>serve_forever())
        serv<span style="color:#f92672">.</span>serve_forever()
    
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">from</span> xmlrpc.client <span style="color:#f92672">import</span> ServerProxy
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">=</span> ServerProxy(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://localhost:15000</span><span style="color:#e6db74">&#39;</span>, allow_none<span style="color:#f92672">=</span>True)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s<span style="color:#f92672">.</span>set(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">foo</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">bar</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> s<span style="color:#f92672">.</span>set(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">spam</span><span style="color:#e6db74">&#39;</span>, [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>])
</code></pre></div><h3 id="python-1">在不同的Python解释器之间交互</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> multiprocessing.connection <span style="color:#f92672">import</span> Listener
<span style="color:#f92672">import</span> traceback

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">echo_client</span>(conn):
    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">while</span> True:
            msg <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>recv()
            conn<span style="color:#f92672">.</span>send(msg)
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">EOFError</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Connection closed</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">serve_forever</span>(serv):
    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">while</span> True:
            client <span style="color:#f92672">=</span> serv<span style="color:#f92672">.</span>accept()
            echo_client(client)
    <span style="color:#66d9ef">except</span> (<span style="color:#a6e22e">KeyboardInterrupt</span>, ConnectionAbortedError):
        <span style="color:#66d9ef">pass</span>
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
        traceback<span style="color:#f92672">.</span>print_exc()
    <span style="color:#66d9ef">finally</span>:
        serv<span style="color:#f92672">.</span>close()

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
    serv <span style="color:#f92672">=</span> Listener((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">25000</span>), authkey<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">peekaboo</span><span style="color:#e6db74">&#39;</span>)
    nworkers <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
    <span style="color:#f92672">from</span> concurrent.futures.thread <span style="color:#f92672">import</span> ThreadPoolExecutor
    <span style="color:#66d9ef">with</span> ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span>nworkers, thread_name_prefix<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">multiprocessing_listener</span><span style="color:#e6db74">&#39;</span>) <span style="color:#66d9ef">as</span> executor:
        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(nworkers):
            executor<span style="color:#f92672">.</span>submit(serve_forever, serv)
        serve_forever(serv)

<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">from</span> multiprocessing.connection <span style="color:#f92672">import</span> Client
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c <span style="color:#f92672">=</span> Client((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">localhost</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">25000</span>), authkey<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">peekaboo</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>send(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">hello</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>recv()
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">hello</span><span style="color:#e6db74">&#39;</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>send(<span style="color:#ae81ff">42</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>recv()
<span style="color:#ae81ff">42</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>send([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>])
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> c<span style="color:#f92672">.</span>recv()
[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]
</code></pre></div><h3 id="heading-58">简单的客户端认证</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> hmac
<span style="color:#f92672">import</span> os

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">client_authenticate</span>(connection, secret_key):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    Authenticate client to a remote service.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    connection represents a network connection.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    secret_key is a key known only to both client/server.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#39;&#39;&#39;</span>
    message <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">32</span>)
    hash <span style="color:#f92672">=</span> hmac<span style="color:#f92672">.</span>new(secret_key, message)
    digest <span style="color:#f92672">=</span> hash<span style="color:#f92672">.</span>digest()
    connection<span style="color:#f92672">.</span>send(digest)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">server_authenticate</span>(connection, secret_key):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    Request client authentication.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#39;&#39;&#39;</span>
    message <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">32</span>)
    connection<span style="color:#f92672">.</span>send(message)
    hash <span style="color:#f92672">=</span> hmac<span style="color:#f92672">.</span>new(secret_key, message)
    digest <span style="color:#f92672">=</span> hash<span style="color:#f92672">.</span>digest()
    response <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span>recv(len(digest))
    <span style="color:#66d9ef">return</span> hmac<span style="color:#f92672">.</span>compare_digest(digest,response)
  
<span style="color:#f92672">from</span> socket <span style="color:#f92672">import</span> socket, AF_INET, SOCK_STREAM

secret_key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">peekaboo</span><span style="color:#e6db74">&#39;</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">echo_handler</span>(client_sock):
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> server_authenticate(client_sock, secret_key):
        client_sock<span style="color:#f92672">.</span>close()
        <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">while</span> True:

        msg <span style="color:#f92672">=</span> client_sock<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">8192</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> msg:
            <span style="color:#66d9ef">break</span>
        client_sock<span style="color:#f92672">.</span>sendall(msg)
        

<span style="color:#f92672">from</span> socket <span style="color:#f92672">import</span> socket, AF_INET, SOCK_STREAM
secret_key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">peekaboo</span><span style="color:#e6db74">&#39;</span>
s <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM)
s<span style="color:#f92672">.</span>connect((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">localhost</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">18000</span>))
client_authenticate(s, secret_key)
s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Hello World</span><span style="color:#e6db74">&#39;</span>)
resp <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</code></pre></div><h3 id="ssl">在网络服务中加入SSL</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> ssl

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SSLMixin</span>:
<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Mixin class that adds support for SSL to existing servers based</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">on the socketserver module.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span>
<span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args,
             keyfile<span style="color:#f92672">=</span>None, certfile<span style="color:#f92672">=</span>None, ca_certs<span style="color:#f92672">=</span>None,
             cert_reqs<span style="color:#f92672">=</span>ssl<span style="color:#f92672">.</span>CERT_NONE,
             <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs):
    self<span style="color:#f92672">.</span>_keyfile <span style="color:#f92672">=</span> keyfile
    self<span style="color:#f92672">.</span>_certfile <span style="color:#f92672">=</span> certfile
    self<span style="color:#f92672">.</span>_ca_certs <span style="color:#f92672">=</span> ca_certs
    self<span style="color:#f92672">.</span>_cert_reqs <span style="color:#f92672">=</span> cert_reqs
    super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_request</span>(self):
    client, addr <span style="color:#f92672">=</span> super()<span style="color:#f92672">.</span>get_request()
    client_ssl <span style="color:#f92672">=</span> ssl<span style="color:#f92672">.</span>wrap_socket(client,
                                 keyfile <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_keyfile,
                                 certfile <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_certfile,
                                 ca_certs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_ca_certs,
                                 cert_reqs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_cert_reqs,
                                 server_side <span style="color:#f92672">=</span> True)
    <span style="color:#66d9ef">return</span> client_ssl, addr
  
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SSLSimpleXMLRPCServer</span>(SSLMixin, SimpleXMLRPCServer):
    <span style="color:#66d9ef">pass</span>
  
<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
    KEYFILE<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">server_key.pem</span><span style="color:#e6db74">&#39;</span>    <span style="color:#75715e"># Private key of the server</span>
    CERTFILE<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">server_cert.pem</span><span style="color:#e6db74">&#39;</span>  <span style="color:#75715e"># Server certificate</span>
    kvserv <span style="color:#f92672">=</span> KeyValueServer((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">15000</span>),
                            keyfile<span style="color:#f92672">=</span>KEYFILE,
                            certfile<span style="color:#f92672">=</span>CERTFILE)
    kvserv<span style="color:#f92672">.</span>serve_forever()
</code></pre></div><h3 id="io">理解事件驱动的IO</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventHandler</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fileno</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Return the associated file descriptor</span><span style="color:#e6db74">&#39;</span>
        <span style="color:#66d9ef">raise</span> NotImplemented(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">must implement</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wants_to_receive</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Return True if receiving is allowed</span><span style="color:#e6db74">&#39;</span>
        <span style="color:#66d9ef">return</span> False

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_receive</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Perform the receive operation</span><span style="color:#e6db74">&#39;</span>
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wants_to_send</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Return True if sending is requested</span><span style="color:#e6db74">&#39;</span>
        <span style="color:#66d9ef">return</span> False

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_send</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Send outgoing data</span><span style="color:#e6db74">&#39;</span>
        <span style="color:#66d9ef">pass</span>
 
<span style="color:#f92672">import</span> select

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">event_loop</span>(handlers):
    <span style="color:#66d9ef">while</span> True:
        wants_recv <span style="color:#f92672">=</span> [h <span style="color:#66d9ef">for</span> h <span style="color:#f92672">in</span> handlers <span style="color:#66d9ef">if</span> h<span style="color:#f92672">.</span>wants_to_receive()]
        wants_send <span style="color:#f92672">=</span> [h <span style="color:#66d9ef">for</span> h <span style="color:#f92672">in</span> handlers <span style="color:#66d9ef">if</span> h<span style="color:#f92672">.</span>wants_to_send()]
        can_recv, can_send, _ <span style="color:#f92672">=</span> select<span style="color:#f92672">.</span>select(wants_recv, wants_send, [])
        <span style="color:#66d9ef">for</span> h <span style="color:#f92672">in</span> can_recv:
            h<span style="color:#f92672">.</span>handle_receive()
        <span style="color:#66d9ef">for</span> h <span style="color:#f92672">in</span> can_send:
            h<span style="color:#f92672">.</span>handle_send()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> socket
<span style="color:#f92672">import</span> time

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UDPServer</span>(EventHandler):
    <span style="color:#66d9ef">def</span> __init__(self, address):
        self<span style="color:#f92672">.</span>sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_DGRAM)
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>bind(address)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fileno</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>fileno()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wants_to_receive</span>(self):
        <span style="color:#66d9ef">return</span> True

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UDPTimeServer</span>(UDPServer):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_receive</span>(self):
        msg, addr <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>recvfrom(<span style="color:#ae81ff">1</span>)
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>sendto(time<span style="color:#f92672">.</span>ctime()<span style="color:#f92672">.</span>encode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ascii</span><span style="color:#e6db74">&#39;</span>), addr)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UDPEchoServer</span>(UDPServer):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_receive</span>(self):
        msg, addr <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>recvfrom(<span style="color:#ae81ff">8192</span>)
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>sendto(msg, addr)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
    handlers <span style="color:#f92672">=</span> [ UDPTimeServer((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>,<span style="color:#ae81ff">14000</span>)), UDPEchoServer((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>,<span style="color:#ae81ff">15000</span>))  ]
    event_loop(handlers)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TCPServer</span>(EventHandler):
    <span style="color:#66d9ef">def</span> __init__(self, address, client_handler, handler_list):
        self<span style="color:#f92672">.</span>sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>setsockopt(socket<span style="color:#f92672">.</span>SOL_SOCKET, socket<span style="color:#f92672">.</span>SO_REUSEADDR, True)
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>bind(address)
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>listen(<span style="color:#ae81ff">1</span>)
        self<span style="color:#f92672">.</span>client_handler <span style="color:#f92672">=</span> client_handler
        self<span style="color:#f92672">.</span>handler_list <span style="color:#f92672">=</span> handler_list

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fileno</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>fileno()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wants_to_receive</span>(self):
        <span style="color:#66d9ef">return</span> True

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_receive</span>(self):
        client, addr <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>accept()
        <span style="color:#75715e"># Add the client to the event loop&#39;s handler list</span>
        self<span style="color:#f92672">.</span>handler_list<span style="color:#f92672">.</span>append(self<span style="color:#f92672">.</span>client_handler(client, self<span style="color:#f92672">.</span>handler_list))

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TCPClient</span>(EventHandler):
    <span style="color:#66d9ef">def</span> __init__(self, sock, handler_list):
        self<span style="color:#f92672">.</span>sock <span style="color:#f92672">=</span> sock
        self<span style="color:#f92672">.</span>handler_list <span style="color:#f92672">=</span> handler_list
        self<span style="color:#f92672">.</span>outgoing <span style="color:#f92672">=</span> bytearray()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fileno</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>fileno()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close</span>(self):
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>close()
        <span style="color:#75715e"># Remove myself from the event loop&#39;s handler list</span>
        self<span style="color:#f92672">.</span>handler_list<span style="color:#f92672">.</span>remove(self)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wants_to_send</span>(self):
        <span style="color:#66d9ef">return</span> True <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>outgoing <span style="color:#66d9ef">else</span> False

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_send</span>(self):
        nsent <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>send(self<span style="color:#f92672">.</span>outgoing)
        self<span style="color:#f92672">.</span>outgoing <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>outgoing[nsent:]

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TCPEchoClient</span>(TCPClient):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wants_to_receive</span>(self):
        <span style="color:#66d9ef">return</span> True

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_receive</span>(self):
        data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">8192</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> data:
            self<span style="color:#f92672">.</span>close()
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>outgoing<span style="color:#f92672">.</span>extend(data)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
   handlers <span style="color:#f92672">=</span> []
   handlers<span style="color:#f92672">.</span>append(TCPServer((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>,<span style="color:#ae81ff">16000</span>), TCPEchoClient, handlers))
   event_loop(handlers)
</code></pre></div><p>对于阻塞或耗时计算的问题可以通过将事件发送个其他单独的线程池来处理。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
<span style="color:#f92672">import</span> os

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadPoolHandler</span>(EventHandler):
    <span style="color:#66d9ef">def</span> __init__(self, nworkers):
        <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>name <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">posix</span><span style="color:#e6db74">&#39;</span>:
            self<span style="color:#f92672">.</span>signal_done_sock, self<span style="color:#f92672">.</span>done_sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socketpair()
        <span style="color:#66d9ef">else</span>:
            server <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
            server<span style="color:#f92672">.</span>bind((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">127.0.0.1</span><span style="color:#e6db74">&#39;</span>, <span style="color:#ae81ff">0</span>))
            server<span style="color:#f92672">.</span>listen(<span style="color:#ae81ff">1</span>)
            self<span style="color:#f92672">.</span>signal_done_sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET,
                                                  socket<span style="color:#f92672">.</span>SOCK_STREAM)
            self<span style="color:#f92672">.</span>signal_done_sock<span style="color:#f92672">.</span>connect(server<span style="color:#f92672">.</span>getsockname())
            self<span style="color:#f92672">.</span>done_sock, _ <span style="color:#f92672">=</span> server<span style="color:#f92672">.</span>accept()
            server<span style="color:#f92672">.</span>close()

        self<span style="color:#f92672">.</span>pending <span style="color:#f92672">=</span> []
        self<span style="color:#f92672">.</span>pool <span style="color:#f92672">=</span> ThreadPoolExecutor(nworkers)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fileno</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>done_sock<span style="color:#f92672">.</span>fileno()

    <span style="color:#75715e"># Callback that executes when the thread is done</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_complete</span>(self, callback, r):

        self<span style="color:#f92672">.</span>pending<span style="color:#f92672">.</span>append((callback, r<span style="color:#f92672">.</span>result()))
        self<span style="color:#f92672">.</span>signal_done_sock<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">x</span><span style="color:#e6db74">&#39;</span>)

    <span style="color:#75715e"># Run a function in a thread pool</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self, func, args<span style="color:#f92672">=</span>(), kwargs<span style="color:#f92672">=</span>{},<span style="color:#f92672">*</span>,callback):
        r <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>pool<span style="color:#f92672">.</span>submit(func, <span style="color:#f92672">*</span>args, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>kwargs)
        r<span style="color:#f92672">.</span>add_done_callback(<span style="color:#66d9ef">lambda</span> r: self<span style="color:#f92672">.</span>_complete(callback, r))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wants_to_receive</span>(self):
        <span style="color:#66d9ef">return</span> True

    <span style="color:#75715e"># Run callback functions of completed work</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_receive</span>(self):
        <span style="color:#75715e"># Invoke all pending callback functions</span>
        <span style="color:#66d9ef">for</span> callback, result <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>pending:
            callback(result)
            self<span style="color:#f92672">.</span>done_sock<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1</span>)
        self<span style="color:#f92672">.</span>pending <span style="color:#f92672">=</span> []
        
<span style="color:#75715e"># A really bad Fibonacci implementation</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fib</span>(n):
    <span style="color:#66d9ef">if</span> n <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> fib(n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> fib(n <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UDPFibServer</span>(UDPServer):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_receive</span>(self):
        msg, addr <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>recvfrom(<span style="color:#ae81ff">128</span>)
        n <span style="color:#f92672">=</span> int(msg)
        pool<span style="color:#f92672">.</span>run(fib, (n,), callback<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> r: self<span style="color:#f92672">.</span>respond(r, addr))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">respond</span>(self, result, addr):
        self<span style="color:#f92672">.</span>sock<span style="color:#f92672">.</span>sendto(str(result)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ascii</span><span style="color:#e6db74">&#39;</span>), addr)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
    pool <span style="color:#f92672">=</span> ThreadPoolHandler(<span style="color:#ae81ff">16</span>)
    handlers <span style="color:#f92672">=</span> [ pool, UDPFibServer((<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>,<span style="color:#ae81ff">16000</span>))]
    event_loop(handlers)
</code></pre></div>
    </div>

    
    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">徐新杰</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2017-10-07</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">&copy; Copyright 2020 Jeremy Xu</span>
  </p>
</div>

    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/wechat-qr-code.png">
        <span>微信打赏</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/alipay-qr-code.png">
        <span>支付宝打赏</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/python/">python</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/2017/10/apk%E5%8F%8D%E7%BC%96%E8%AF%91%E6%AD%A5%E9%AA%A4/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">apk反编译步骤</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/2017/10/py3_cookbook_notes_01/">
            <span class="next-text nav-default">py3_cookbook_notes_01</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        


<div id="utter-container"></div>
<script src="https://utteranc.es/client.js" repo='jeremyxu2010/blog_comment'
  issue-term="title" theme='github-light' crossorigin="anonymous" async>
  </script>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:jeremyxu2010@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://plus.google.com/u/0/103057094241630654183" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/jeremyxu2010" class="iconfont icon-github" title="github"></a>
  <a href="https://jeremyxu2010.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2016 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">&copy; Copyright 2019 Jeremy Xu</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.min.js?v=3.1.1"></script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\[\[','\]\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
           extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
  
  MathJax.Hub.Queue(function() {
      
      
      
      var all = MathJax.Hub.getAllJax(), i;
      for(i = 0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
  </script>








<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.0/fuse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
<script src="https://jeremyxu2010.github.io/js/search.js"></script>


</body>
</html>
